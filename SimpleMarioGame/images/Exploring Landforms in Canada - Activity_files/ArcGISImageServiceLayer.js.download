// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/3.35/esri/copyright.txt for details.
//>>built
require({cache:{"esri/layers/ImageServiceLayerMixin":function(){define("dojo/_base/declare dojo/_base/lang dojo/_base/Deferred dojo/_base/array dojo/_base/json dojo/_base/config dojo/_base/connect dojo/has dojo/io-query dojo/DeferredList ../kernel ../config ../lang ../request ../deferredUtils ../urlUtils ../geometry/Extent ../geometry/Point ../geometry/Polygon ../renderers/colorRampUtils ./MosaicRule ./RasterFunction ./DimensionalDefinition ./Raster ./PixelBlock ./pixelFilters/VectorFieldPixelFilter ./rasterFormats/ImageCanvasDecoder ./TimeInfo ./Field ../graphic ../tasks/ImageServiceIdentifyTask ../tasks/ImageServiceIdentifyParameters".split(" "),
function(J,z,F,g,b,d,f,e,h,n,r,m,w,u,l,v,B,K,I,S,L,P,Q,R,D,O,N,p,t,E,G,A){J=J(null,{declaredClass:"esri.layers.ImageServiceLayerMixin",_rasterFieldPrefix:"Raster.",_renderingRuleFieldSubPrefix:"ServicePixelValue.",_rasterFunctionServiceInfoProps:"bandCount pixelType hasRasterAttributeTable hasColormap hasHistograms minValues maxValues meanValues stdvValues serviceDataType".split(" "),_pixelTypeRanges:{U1:[0,1],U2:[0,3],U4:[0,15],U8:[0,255],S8:[-128,127],U16:[0,65535],S16:[-32768,32767]},_eventMap:{"rendering-change":!0,
"mosaic-rule-change":!0,"spatial-reference-change":!0,"renderer-change":!0},_cachedVariableStats:{},_cachedVariableHistogram:{},constructor:function(a,c){this.useMapTime=c&&c.hasOwnProperty("useMapTime")?!!c.useMapTime:!0},_initialize:function(a,c){this._url=v.urlToObject(a);this.raster=new R(this._url.path);this._rasterFunctionTemplateInfos={};this._customRenderingRuleId={};this.infoTemplate=c&&c.infoTemplate;this.format=(a=c&&c.imageServiceParameters)&&a.format;this.compressionTolerance=a&&a.compressionTolerance?
a.compressionTolerance:.01;this.interpolation=a?a.interpolation:null;this.compressionQuality=a?a.compressionQuality:null;this.bandIds=a?a.bandIds:null;this.mosaicRule=a?a.mosaicRule:null;this.renderingRule=a?a.renderingRule:null;this.renderer=a?a.renderer:null;this.useMapDimensionValue=c&&c.hasOwnProperty("useMapDimensionValue")?!!c.useMapDimensionValue:!0;this.hasImageFilter=c&&c.hasImageFilter;this.activeMapDimensions=c&&c.activeMapDimensions;this._params=z.mixin({},this._url.query,{f:"image",interpolation:this.interpolation,
format:this.format,compressionQuality:this.compressionQuality,bandIds:this.bandIds?this.bandIds.join(","):null},a?a.toJson():{});this.pixelFilter=c&&c.pixelFilter;this.originalPixelData=this.pixelData=null;this.hasDataChanged=!0;this._requestDataHandler=z.hitch(this,this._requestDataHandler);this._requestDataErrorHandler=z.hitch(this,this._requestDataErrorHandler);this._rasterReadPromise=null;this._initLayer=z.hitch(this,this._initLayer);this._queryVisibleRastersHandler=z.hitch(this,this._queryVisibleRastersHandler);
this._visibleRasters=[];this._rasterAttributeTableFields=[];this._rasterAttributeTableFeatures=[];this._renderingRuleAttributeTable={};this._renderingRuleColormap={};this._useRenderingRuleAttributeTable=!1;this._loadCallback=c&&c.loadCallback;a&&a.renderer&&(a.renderer.outputUnit||a.renderer.inputUnit)&&(this.vectorFieldPixelFilter=new O,this.vectorFieldPixelFilter.setUnits(a.renderer.inputUnit,a.renderer.outputUnit));(c=c&&c.resourceInfo)?this._initLayer(c):u({url:this._url.path,content:z.mixin({f:"json"},
this._url.query),callbackParamName:"callback",load:this._initLayer,error:this._errorHandler});this.registerConnectEvents()},disableClientCaching:!1,_initLayer:function(a,c){if(null!==a&&void 0!==a){this._findCredential();(this.credential&&this.credential.ssl||a&&a._ssl)&&this._useSSL();c=this.minScale;var k=this.maxScale;z.mixin(this,a);this.minScale=c;this.maxScale=k;this.initialExtent=this.fullExtent=this.extent=new B(a.extent);this.spatialReference=this.initialExtent.spatialReference;this.pixelSizeX=
parseFloat(this.pixelSizeX);this.pixelSizeY=parseFloat(this.pixelSizeY);var q=this.minValues,x=this.maxValues,C=this.meanValues,y=this.stdvValues,M=this.bands=[];c=0;for(k=this.bandCount;c<k;c++)M[c]={min:q[c],max:x[c],mean:C[c],stddev:y[c]};this.timeInfo=(c=this.timeInfo)&&c.timeExtent?new p(c):null;k=this.fields=[];if(q=a.fields)for(c=0;c<q.length;c++)k.push(new t(q[c]));this._updateInfoTemplateFields(this.fields);this.version=a.currentVersion;this.version||(this.version="fields"in a||"objectIdField"in
a||"timeInfo"in a?10:9.3);w.isDefined(a.minScale)&&!this._hasMin&&"Raster"!==a.cacheType&&this.setMinScale(a.minScale);w.isDefined(a.maxScale)&&!this._hasMax&&"Raster"!==a.cacheType&&this.setMaxScale(a.maxScale);c={};a.defaultMosaicMethod?(c.method=a.defaultMosaicMethod,c.operation=a.mosaicOperator,c.sortField=a.sortField,c.sortValue=a.sortValue):c.method=L.METHOD_NONE;this.defaultMosaicRule=new L(c);this.defaultMosaicRule.ascending=!0;this._useRenderingRuleAttributeTable=10<this.version&&"esriImageServiceDataTypeThematic"===
this.serviceDataType;this._setDefaultRenderingRule(!0);this._getRenderingRuleAttributeTableAndColormap();this._isScientificData()&&(!this.mosaicRule||this.mosaicRule&&!this.mosaicRule.multidimensionalDefinition)&&this._setDefaultMultidimensionalDefinition(!0);10<this.version&&this.hasRasterAttributeTable&&this.getRasterAttributeTable().then(z.hitch(this,function(H){H&&(H.features&&H.fields&&(this.rasterAttributeTable=z.clone(H)),H.features&&0<H.features.length&&(this._rasterAttributeTableFeatures=
z.clone(H.features)),H.fields&&0<H.fields.length&&(this._rasterAttributeTableFields=z.clone(H.fields)),this.renderingRule||!this.renderer||"esri.renderer.ClassBreaksRenderer"!==this.renderer.declaredClass&&"esri.renderer.UniqueValueRenderer"!==this.renderer.declaredClass||this.refresh())}));this._initVectorPixelFilter();this.bandIds||2!==this.bandCount||this.renderingRule||"esri.layers.ArcGISImageServiceLayer"!==this.declaredClass||this.setBandIds([0,0,0],!0);10.3<=this.version&&this.rasterFunctionInfos&&
this.rasterFunctionInfos.length&&this.getRasterFunctionInfos().then(z.hitch(this,function(H){if(H&&H.length){this.rasterFunctionInfos=H;var V=[],X;g.forEach(H,function(W){if(W){var U=W.functionType;X=X||1===U||2===U;V.push(W.name)}},this);this._hasItemLevelRFT=X;this._rasterFunctionNames=V;X&&(this._initVectorPixelFilter(),this.refresh())}}));this.loaded=!0;this._setDefaultFilter();this.onLoad(this);if(a=this._loadCallback)delete this._loadCallback,a(this)}},_updateInfoTemplateFields:function(a){if(a&&
!(1>a.length)&&this.infoTemplate&&this.infoTemplate.info&&this.infoTemplate.info.fieldInfos&&!(1>this.infoTemplate.info.fieldInfos.length)){var c,k;var q=this.infoTemplate.info.fieldInfos;for(c=0;c<a.length;c++){var x=a[c];for(k=0;k<q.length;k++)if(q[k].fieldName.toLowerCase()===x.name.toLowerCase()&&q[k].fieldName!==x.name){q[k].fieldName=x.name;break}}}},getKeyProperties:function(a){var c=this._url.path+"/keyProperties",k=new F(l._dfdCanceller),q={f:"json"};a&&a.renderingRule&&(q.renderingRule=
b.toJson(a.renderingRule.toJson()));10<this.version?(k._pendingDfd=u({url:c,content:q,handleAs:"json",callbackParamName:"callback"}),k._pendingDfd.then(function(x){k.callback(x)},function(x){k.errback(x)})):(a=Error("Layer does not have key properties"),a.log=!!d.isDebug,k.errback(a));return k},getRasterAttributeTable:function(a){var c=this._url.path+"/rasterAttributeTable",k=new F(l._dfdCanceller),q={f:"json"},x=this.hasRasterAttributeTable;a&&a.renderingRule&&(q.renderingRule=b.toJson(a.renderingRule.toJson()),
x=!0);!this.loaded||10<this.version&&x?(k._pendingDfd=u({url:c,content:q,handleAs:"json",callbackParamName:"callback"}),k._pendingDfd.then(function(C){k.callback(C)},function(C){k.errback(C)})):(a=Error("Layer does not support raster attribute table"),a.log=!!d.isDebug,k.errback(a));return k},getRenderingRuleAttributeTable:function(a){var c=new F(l._dfdCanceller);if(!a||!a.renderingRule)return c.errback(Error("Rendering rule is not specified")),c;a=a.renderingRule;var k=this._getRenderingRuleId(a);
this._renderingRuleAttributeTable&&k&&this._renderingRuleAttributeTable.hasOwnProperty(k)?c.resolve(this._renderingRuleAttributeTable[k]):c=this.getRasterAttributeTable({renderingRule:a}).then(z.hitch(this,function(q){if(q&&q.features&&q.features.length&&q.fields&&q.fields.length){var x={features:z.clone(q.features),fields:z.clone(q.fields)};k&&(this._renderingRuleAttributeTable[k]=x)}return x}));return c},_initVectorPixelFilter:function(){var a;this._hasItemLevelRFT&&this.renderingRule&&(a=this._getItemLevelRenderingRule(this.renderingRule));
if(a=a||this.renderingRule)return this.getRenderingRuleServiceInfo(a).then(z.hitch(this,function(c){!c||!this._isVectorData(c)&&"esri.layers.ArcGISImageServiceVectorLayer"!==this.declaredClass||w.isDefined(this.pixelFilter)||(this.vectorFieldPixelFilter=this.vectorFieldPixelFilter||new O,this.vectorFieldPixelFilter.isDataUV="esriImageServiceDataTypeVector-UV"===c.serviceDataType,this.pixelFilter=this.vectorFieldPixelFilter.computeMagnitudeAndDirection,this.getKeyProperties().then(z.hitch(this,this._setFlowRepresentation)),
this._applyVectorResamplingType(c.serviceDataType))}))},_applyVectorResamplingType:function(a){if(a){var c=this.renderingRule;c&&"Resample"===c.functionName&&((c.functionArguments||{}).ResamplingType="esriImageServiceDataTypeVector-UV"===a?7:10,this.setRenderingRule(new P(c.toJson())))}},_getRasterAttributeTableFeatures:function(){var a=new F;if(this._rasterAttributeTableFeatures&&0<this._rasterAttributeTableFeatures.length)return a.resolve(this._rasterAttributeTableFeatures),a;if(10<this.version&&
this.hasRasterAttributeTable)return a=this.getRasterAttributeTable(),a.then(z.hitch(this,function(c){c&&c.features&&0<c.features.length&&(this._rasterAttributeTableFeatures=z.clone(c.features))})),a;a.resolve(this._rasterAttributeTableFeatures);return a},_getRenderingRuleAttributeTableFeatures:function(a){a=a&&a.renderingRule;return a?this.getRenderingRuleAttributeTable({renderingRule:a}).then(function(c){return c&&c.features}):(a=new F,a.errback(Error("Rendering rule is not specified")),a)},_getRenderingRuleAttributeTableAndColormap:function(){this.renderingRule&&
this.getRenderingRuleServiceInfo(this.renderingRule).then(z.hitch(this,function(a){a.hasRasterAttributeTable&&this.getRenderingRuleAttributeTable({renderingRule:this.renderingRule}).then(z.hitch(this,function(){!this.renderer||"esri.renderer.ClassBreaksRenderer"!==this.renderer.declaredClass&&"esri.renderer.UniqueValueRenderer"!==this.renderer.declaredClass||this.refresh()}));a.hasColormap&&this.getRenderingRuleColormap({renderingRule:this.renderingRule}).then(z.hitch(this,function(){this.renderer&&
"esri.renderer.ColormapRenderer"===this.renderer.declaredClass&&this.refresh()}))}))},getCustomRasterFields:function(a){var c=a?a.rasterAttributeTableFieldPrefix:this._rasterFieldPrefix;a=10.3<=this.version?"esriFieldTypeDouble":"esriFieldTypeString";var k={name:this._rasterFieldPrefix+"ItemPixelValue",alias:"Item Pixel Value",domain:null,editable:!1,length:50,type:a},q={name:this._rasterFieldPrefix+"ServicePixelValue",alias:"Service Pixel Value",domain:null,editable:!1,length:50,type:a},x={name:this._rasterFieldPrefix+
"ServicePixelValue.Raw",alias:"Raw Service Pixel Value",domain:null,editable:!1,length:50,type:"esriFieldTypeDouble"},C=this.fields?z.clone(this.fields):[];a=C.length;C[a]=q;10.4<=this.version&&"esri.layers.ArcGISImageServiceLayer"===this.declaredClass&&(!this.rasterFunctionInfos||!this.rasterFunctionInfos.length||this._isRenderingRuleAProcessingTemplate({functionName:"none"}))&&(a++,C[a]=x);if(this.capabilities&&-1<this.capabilities.toLowerCase().indexOf("catalog")||this.fields&&0<this.fields.length)a++,
C[a]=k;!w.isDefined(this.pixelFilter)||"esriImageServiceDataTypeVector-UV"!==this.serviceDataType&&"esriImageServiceDataTypeVector-MagDir"!==this.serviceDataType||(k={name:this._rasterFieldPrefix+"Magnitude",alias:"Magnitude",domain:null,editable:!1,type:"esriFieldTypeDouble"},q={name:this._rasterFieldPrefix+"Direction",alias:"Direction",domain:null,editable:!1,type:"esriFieldTypeDouble"},a++,C[a]=k,a++,C[a]=q);a=this._rasterAttributeTableFields;(k=this.renderingRule&&this._getRenderingRuleId(this.renderingRule))&&
this._renderingRuleAttributeTable&&this._renderingRuleAttributeTable.hasOwnProperty(k)&&(a=this._renderingRuleAttributeTable[k].fields);a&&0<a.length&&(a=g.filter(a,function(M){return"esriFieldTypeOID"!==M.type&&"value"!==M.name.toLowerCase()}),a=g.map(a,function(M){var H=z.clone(M);H.name=c+M.name;return H}),C=C.concat(a));var y=this._rasterFieldPrefix+this._renderingRuleFieldSubPrefix;10.4<=this.version&&this.rasterFunctionInfos&&g.forEach(this.rasterFunctionInfos,function(M){M&&M.name&&"none"!==
M.name.toLowerCase()&&(M={name:y+M.name.replace(/ /gi,"_"),alias:M.name,domain:null,editable:!1,type:"esriFieldTypeDouble"},C.push(M))});return C},_applyTimeToMultidimensionalCRF:function(a,c){var k=this._isTimeSupportedOnCRF();if(k&&(!a||!a.multidimensionalDefinition))return a;var q=this.timeInfo&&this.timeInfo.startTimeField;if((c=c||this._params.time)&&q&&this._isMultidimensionalCRF()){a=z.clone(a||this.defaultMosaicRule)||new L;a.multidimensionalDefinition=a.multidimensionalDefinition||[];var x=
a.multidimensionalDefinition.filter(function(y){return y.dimensionName===q}),C=c.split(",").map(function(y){return parseInt(y,10)});2===C.length&&C[0]===C[1]&&(C.length=1);0<x.length?k?a.multidimensionalDefinition.forEach(function(y){y.dimensionName===q&&(y.dimensionName=null,y.isSlice=null,y.values=null)}):a.multidimensionalDefinition.forEach(function(y){y.dimensionName===q&&(y.isSlice=1===C.length,y.values=1===C.length?C:[C])}):k||(a.multidimensionalDefinition.some(function(y){return null!=y.variableName&&
null==y.dimensionName})?a.multidimensionalDefinition.forEach(function(y){null!=y.variableName&&null==y.dimensionName&&(y.dimensionName=q,y.isSlice=1===C.length,y.values=1===C.length?C:[C])}):a.multidimensionalDefinition.push(new Q({variableName:"",dimensionName:q,isSlice:1===C.length,values:1===C.length?C:[C]})));this._cleanupMultidimensionalDefinition(a)}return a},_prepareGetImageParameters:function(a,c,k,q){q=w.isDefined(q)?q:this._params;if(this.renderer||this._hasItemLevelRFT&&this.renderingRule){var x=
this.getExportImageRenderingRule();q.renderingRule=x?b.toJson(x.toJson()):null}x=this.getExportImageMosaicRule(q);q.mosaicRule=x?b.toJson(x.toJson()):null;x=a.spatialReference.wkid||b.toJson(a.spatialReference.toJson(!1));delete q._ts;z.mixin(q,{bbox:a.xmin+","+a.ymin+","+a.xmax+","+a.ymax,imageSR:x,bboxSR:x,size:c+","+k},this.disableClientCaching?{_ts:(new Date).getTime()}:{});delete q.compressionTolerance;q.format&&"LERC"===q.format.toUpperCase()&&(q.compressionTolerance=this.compressionTolerance);
q.token=this._getToken()},getImageUrl:function(a,c,k,q,x){x=w.isDefined(x)?x:this._params;this._prepareGetImageParameters(a,c,k,x);a=z.clone(x);this._cleanupRequestParams(a);c=this._url.path+"/exportImage?";k=v.addProxy(c+h.objectToQuery(z.mixin(a,{f:"image"})));var C=a.token;k.length>m.defaults.io.postLength||this.useMapImage?this._jsonRequest=u({url:c,content:z.mixin(a,{f:"json"}),callbackParamName:"callback",load:function(y,M){y=y.href;C&&(y+=-1===y.indexOf("?")?"?token\x3d"+C:"\x26token\x3d"+
C);q(v.addProxy(y))},error:this._errorHandler}):q(k)},onRenderingChange:function(){},onMosaicRuleChange:function(){},onRendererChange:function(){},setInterpolation:function(a,c){this.interpolation=this._params.interpolation=a;c||this.refresh(!0)},setCompressionQuality:function(a,c){this.compressionQuality=this._params.compressionQuality=a;c||this.refresh(!0)},setCompressionTolerance:function(a,c){this.compressionTolerance=a;c||this.refresh(!0)},setBandIds:function(a,c){var k=!1;this.bandIds!==a&&
(k=!0);this.bandIds=a;this._params.bandIds=a.join(",");if(k&&!c)this.onRenderingChange();c||this.refresh(!0)},setDefaultBandIds:function(a){this.bandIds=this._params.bandIds=null;a||this.refresh(!0)},setDisableClientCaching:function(a){this.disableClientCaching=a},setMosaicRule:function(a,c){var k=!1;this.mosaicRule!==a&&(k=!0);this.mosaicRule=a;this._params.mosaicRule=b.toJson(a.toJson());if(k&&!c)this.onMosaicRuleChange();c||this.refresh(!0)},getRasterFunctionInfos:function(){if(10.3>this.version||
!this.rasterFunctionInfos||!this.rasterFunctionInfos.length)console.log("Layer doesn't support /rasterFunctionInfos resource.");else return u({url:this._url.path+"/rasterFunctionInfos",content:{f:"json"},handleAs:"json",load:function(a){return a&&a.rasterFunctionInfos}})},setRenderingRule:function(a,c){var k=!1;this.renderingRule!==a&&(k=!0);this.renderingRule=a;this._params.renderingRule=a?b.toJson(a.toJson()):null;this._useRenderingRuleAttributeTable?this.getRenderingRuleAttributeTable({renderingRule:a}):
"esri.layers.RasterXLayer"!==this.declaredClass&&this._getRenderingRuleAttributeTableAndColormap();if(k)this.onRenderingChange();this._setDefaultFilter();c||this.refresh(!0)},setImageFormat:function(a,c){this.format=this._params.format=a;this._setDefaultFilter();c||this.refresh(!0)},setInfoTemplate:function(a){this.infoTemplate=a;this._updateInfoTemplateFields(this.fields)},setDefinitionExpression:function(a,c){var k=this.mosaicRule?this.mosaicRule.toJson():{};this.mosaicRule||(this.defaultMosaicRule?
k=this.defaultMosaicRule.toJson():k.method=L.METHOD_NONE);k.where=a;a=new L(k);this.setMosaicRule(a,c);return this},getDefinitionExpression:function(){return this.mosaicRule?this.mosaicRule.where:null},setPixelFilter:function(a){this.pixelFilter=a;this._isDefaultPixelFilter=!1},getPixelData:function(a){return a?(this._useBrowserDecoding()&&(this.originalPixelData={pixelBlock:this._getPixelBlockFromCanvas(this._context,this._map.width,this._map.height),extent:this._map.extent}),this.originalPixelData):
this.pixelData},getExportImageRenderingRule:function(){var a;this._hasItemLevelRFT&&this.renderingRule&&(a=this._getServiceLevelRenderingRule(this.renderingRule));a=a||this.renderingRule;this._isItemLevelRasterFunction(this.renderingRule)&&(a=void 0);return this._combineRenderingRule(this._convertRendererToRenderingRule(this.renderer),a)},getExportImageMosaicRule:function(){var a=this.mosaicRule,c;this._hasItemLevelRFT&&this.renderingRule&&(c=this._getItemLevelRenderingRule(this.renderingRule));c&&
(a=a||this.defaultMosaicRule||new L,a.itemRenderingRule=c);return a=this._applyTimeToMultidimensionalCRF(a)},redraw:function(){this.hasDataChanged=!1;this._setPixelData(this.originalPixelData)},getHistograms:function(a){var c=new F(l._dfdCanceller);if(a&&this._cachedVariableHistogram[a])return c.resolve(this._cachedVariableHistogram[a]),c;if(this.hasHistograms){var k={f:"json"};a&&(k.variable=a);c._pendingDfd=u({url:this._url.path+"/histograms",content:k,handleAs:"json",callbackParamName:"callback"});
c._pendingDfd.then(z.hitch(this,function(q){a&&(this._cachedVariableHistogram[a]=q);c.callback(q)}),function(q){c.errback(q)})}else k=Error("Layer does not have histograms."),k.log=!!d.isDebug,c.errback(k);return c},computeHistograms:function(a){var c=new F(l._dfdCanceller);if(10.1<=this.currentVersion){a=a||{};var k=a.geometry||this.fullExtent,q=(a.geometry||this.fullExtent).toJson();k="extent"===k.type?"esriGeometryEnvelope":"esriGeometryPolygon";var x=a.renderingRule||this.renderingRule||this.defaultRenderingRule;
x=x?x.toJson():null;var C=a.mosaicRule||this.mosaicRule||this.defaultMosaicRule;C=C?C.toJson():null;a=a.pixelSize||{x:this.pixelSizeX,y:this.pixelSizeY};c._pendingDfd=u({url:this._url.path+"/computeHistograms",content:z.mixin({f:"json",geometry:JSON.stringify(q),geometryType:k,renderingRule:JSON.stringify(x),mosaicRule:JSON.stringify(C),pixelSize:JSON.stringify(a),callbackParamName:"callback"}),handleAs:"json"});c._pendingDfd.then(function(y){c.callback(y)},function(y){c.errback(y)})}else q=Error("Layer doesn't support computeHistograms."),
q.log=!!d.isDebug,c.errback(q);return c},getRenderingRuleServiceInfo:function(a,c){function k(C){return C.name&&C.arguments&&C.function&&C.hasOwnProperty("functionType")}var q=new l._fixDfd(new F(l._dfdCanceller));if(!a)return q.errback(Error("Rendering rule is not specified")),q;if(!k(a)){var x=this._getRenderingRuleId(a);if(x&&this._rasterFunctionTemplateInfos[x])return q.resolve(this._rasterFunctionTemplateInfos[x]),q}return u({url:this._url.path,content:z.mixin(z.mixin({f:"json",renderingRule:JSON.stringify(a.toJson())},
this._url.query)),callbackParamName:"callback",load:z.hitch(this,function(C){var y={};g.forEach(this._rasterFunctionServiceInfoProps,function(M){y[M]=C[M]});k(a)||(this._rasterFunctionTemplateInfos[x]=y);return y}),error:c||this._errorHandler})},queryVisibleRasters:function(a,c,k,q){var x=this._map,C=l._fixDfd(new F(l._dfdCanceller));this._visibleRasters=[];var y,M,H=!0,V=!0,X=null,W=this.infoTemplate?this.infoTemplate.info:null,U=W?z.clone(this.infoTemplate.info.fieldInfos):null;c=c||{};if(W&&this.infoTemplate.info.mediaInfos&&
this.infoTemplate.info.mediaInfos.length){var Y=[];g.forEach(this.infoTemplate.info.mediaInfos,function(T){Y=Y.concat(T&&T.value&&T.value.fields||[])});Y.length&&g.forEach(U,function(T){T&&-1<Y.indexOf(T.fieldName)&&(T.visible=!0)})}if(U&&0<U.length)for(H=!1,y=0;y<U.length;y++)if((M=U[y])&&M.fieldName.toLowerCase()!==this._rasterFieldPrefix.toLowerCase()+"servicepixelvalue"&&(M.visible||W.title&&-1<W.title.toLowerCase().indexOf(M.fieldName.toLowerCase()))){H=!0;break}this.infoTemplate&&this.infoTemplate.info&&
this.infoTemplate.info.layerOptions&&this.infoTemplate.info.layerOptions.hasOwnProperty("returnTopmostRaster")&&(X=this.infoTemplate.info.layerOptions.returnTopmostRaster?1:null);U&&0<U.length&&(V=!1,g.some(U,function(T){if(T&&T.fieldName.toLowerCase()===this._rasterFieldPrefix.toLowerCase()+"itempixelvalue"&&T.visible)return V=!0},this));var da=(M=this._removeVisualizationStretchFunction(this.renderingRule))&&M.functionName,ea=[];if(10.4<=this.version){var fa=!1;if(this.rasterFunctionInfos&&U){var ba=
this._rasterFieldPrefix+this._renderingRuleFieldSubPrefix;g.forEach(this.rasterFunctionInfos,function(T){var ia=ba+T.name.replace(/ /gi,"_");g.some(U,function(ja){return ja.visible&&ja.fieldName===ia})&&(fa=fa||da&&da===T.name,ea.push(new P({rasterFunction:T.name})))})}M&&!fa&&ea.push(M)}y=new A;y.geometry=a.geometry;y.returnGeometry=this._map.spatialReference.equals(this.spatialReference);y.returnCatalogItems=H;y.timeExtent=this.timeInfo?a.timeExtent:null;y.returnPixelValues=V;y.maxItemCount=X||
a.maxItemCount;this._params.time&&this.mosaicRule?(a=z.clone(this.mosaicRule),a=this._filterOutTimeDimension(a),y.mosaicRule=a):y.mosaicRule=this.mosaicRule||null;this._isMultidimensionalCRF()&&y.timeExtent&&(y.mosaicRule=this._applyTimeToMultidimensionalCRF(y.mosaicRule,y.timeExtent.toJson().join(",")),this._isTimeSupportedOnCRF()||delete y.timeExtent);y.renderingRule=10.4>this.version&&M||null;y.renderingRules=ea||null;10.8>this.version&&(y.returnPixelValues=void 0,y.maxItemCount=void 0);x&&(x=
new K((x.extent.xmax-x.extent.xmin)/x.width,(x.extent.ymax-x.extent.ymin)/x.height,x.extent.spatialReference),y.pixelSize=x);c.requestParams=y;var ha=this;x=new G(this.url);(C._pendingDfd=x.execute(y)).addCallbacks(function(T){ha._queryVisibleRastersHandler(T,c,k,q,C)},function(T){ha._resolve([T],null,q,C,!0)});return C},_queryVisibleRastersHandler:function(a,c,k,q,x){function C(){var Z=this.getCustomRasterFields(c),ma=this._getDomainFields(Z),ta=c?c.returnDomainValues:!1,Aa=c&&c.rasterAttributeTableFieldPrefix,
ka,ua,qa,va,la,ra,Ba,wa,xa,ya;Z=(Z=this._getRenderingRuleId(this.renderingRule))&&this._rasterFunctionTemplateInfos[Z];this.renderingRule&&(this._useRenderingRuleAttributeTable||Z)?(Z=this._getRenderingRuleAttributeTableFeatures({renderingRule:this.renderingRule}),this.hasRasterAttributeTable||(ya=y)):Z=this._getRasterAttributeTableFeatures();Z.then(z.hitch(this,function(za){for(ka=0;ka<T.length;ka++){ca=T[ka];ca.setInfoTemplate(this.infoTemplate);ca._layer=this;if(y){xa=y.replace(/ /gi,"").split(",");
ua=y;qa=xa;ia&&ia.length>=ka&&(ua=ia[ka].replace(/ /gi,", "),qa=ia[ka].split(" "));ca.attributes[this._rasterFieldPrefix+"ItemPixelValue"]=qa;ca.attributes[this._rasterFieldPrefix+"ServicePixelValue"]=xa;M&&(ca.attributes[this._rasterFieldPrefix+"ServicePixelValue.Raw"]=M.replace(/ /gi,"").split(","));if(this.pixelFilter){var sa=new D({height:1,width:1,pixelType:"F32",pixels:[],statistics:[]});g.forEach(qa,function(aa){sa.addData({pixels:[aa],statistics:{minValue:aa,maxValue:aa,noDataValue:null}})});
this.pixelFilter({pixelBlock:sa,extent:new B(0,0,0,0,this._map.spatialReference)});if("esriImageServiceDataTypeVector-UV"===this.serviceDataType||"esriImageServiceDataTypeVector-MagDir"===this.serviceDataType)ca.attributes[this._rasterFieldPrefix+"Magnitude"]=sa.pixels[0][0],ca.attributes[this._rasterFieldPrefix+"Direction"]=sa.pixels[1][0]}g.forEach(U,function(aa){ca.attributes[aa.name]=aa.value});var Ca=0<this.fields.length?ya||ua:ya||M;if(za&&0<za.length&&(va=g.filter(za,function(aa){if(aa&&aa.attributes)return aa.attributes.hasOwnProperty("Value")?
aa.attributes.Value==Ca:aa.attributes.VALUE==Ca}),0<va.length&&(la=z.clone(va[0]),Aa&&la))){wa={};for(ra in la.attributes)la.attributes.hasOwnProperty(ra)&&(Ba=Aa+ra,wa[Ba]=la.attributes[ra]);la.attributes=wa;ca.attributes=z.mixin(ca.attributes,la.attributes)}}ta&&ma&&0<ma.length&&g.forEach(ma,function(aa){if(aa){var na=ca.attributes[aa.name];w.isDefined(na)&&(na=this._getDomainValue(aa.domain,na),w.isDefined(na)&&(ca.attributes[aa.name]=na))}},this);oa.push(ca);this._visibleRasters.push(ca)}this._resolve([oa,
null,!0],null,k,x)}))}var y=a.value,M=a.value,H=0,V=0,X=this,W=this.objectIdField,U=[];q=c.requestParams.renderingRules;var Y=a.processedValues,da=this.renderingRule&&b.toJson(this._removeVisualizationStretchFunction(this.renderingRule).toJson());if(q&&Y&&q.length===Y.length){var ea=this._rasterFieldPrefix+this._renderingRuleFieldSubPrefix;g.forEach(q,function(Z,ma){if(Z.functionName){var ta={name:ea+Z.functionName.replace(/ /gi,"_"),value:Y[ma].replace(/ /gi,"").split(",")};U.push(ta);da&&da===b.toJson(Z.toJson())&&
(y=Y[ma])}})}q=this.infoTemplate&&this.infoTemplate.info&&this.infoTemplate.info.layerOptions&&this.infoTemplate.info.layerOptions.hasOwnProperty("showNoDataRecords")?this.infoTemplate.info.layerOptions.showNoDataRecords:!0;if(a.catalogItems){var fa=0,ba=a.catalogItems.features.length;var ha=0;var T=Array(ba);var ia=Array(ba);var ja=Array(ba);if(a.properties&&a.properties.Values){ba=a.properties.Values.length;for(H=0;H<ba;H++)-1<a.properties.Values[H].toLowerCase().indexOf("nodata")&&ha++;var Da=
ba-ha;for(H=0;H<ba;H++){ha=!0;if(-1<a.properties.Values[H].toLowerCase().indexOf("nodata")){var pa=Da++;q||(ha=!1,T.length--,ia.length--,ja.length--)}else pa=fa++;ha&&(T[pa]=a.catalogItems.features[H],ia[pa]=a.properties.Values[H],ja[pa]=T[pa].attributes[W])}}else{for(H=0;H<ba;H++)T[H]=a.catalogItems.features[H],ja[H]=T[H].attributes[W];ia=null}}this._visibleRasters=[];(a=-1<y.toLowerCase().indexOf("nodata"))&&!q&&(T=[],ia=[],ja=[]);if(y&&!T&&!a){W="ObjectId";T=[];var ca=new E(new B(this.fullExtent),
null,{ObjectId:0});T.push(ca)}var oa=[];T?!this._map.spatialReference.equals(this.spatialReference)&&ja&&0<ja.length?u({url:this._url.path+"/query",content:{f:"json",objectIds:ja.join(","),returnGeometry:!0,outSR:b.toJson(X._map.spatialReference.toJson()),outFields:W},handleAs:"json",callbackParamName:"callback",load:function(Z){if(0===Z.features.length)X._resolve([oa,null,null],null,k,x);else{for(H=0;H<Z.features.length;H++)for(V=0;V<T.length;V++)T[V].attributes[W]==Z.features[H].attributes[W]&&
(T[V].geometry=new I(Z.features[H].geometry),T[V].geometry.setSpatialReference(X._map.spatialReference));C.call(X)}},error:function(Z){X._resolve([oa,null,null],null,k,x)}}):C.call(this):this._resolve([oa,null,null],null,k,x)},getVisibleRasters:function(){var a=this._visibleRasters,c=[],k;for(k in a)a.hasOwnProperty(k)&&c.push(a[k]);return c},_getDomainFields:function(a){if(a){var c=[];g.forEach(a,function(k){if(k.domain){var q={};q.name=k.name;q.domain=k.domain;c.push(q)}});return c}},_getDomainValue:function(a,
c){if(a&&a.codedValues){var k;g.some(a.codedValues,function(q){return q.code===c?(k=q.name,!0):!1});return k}},_requestData:function(a,c,k){this._rasterReadPromise&&this._rasterReadPromise.cancel();a=z.clone(a);var q=a._normalize(!0);this._prepareGetImageParameters(q,c,k);c=z.clone(this._params);this._cleanupRequestParams(c);c.extent=a;c.format=c.format||(10.3<=this.version?"lerc":"jpgpng");"lerc"===c.format.toLowerCase()&&!c.lercVersion&&10.5<=this.version&&(c.lercVersion=2);this._params.time&&this._isMultidimensionalCRF()&&
!this._isTimeSupportedOnCRF()&&delete c.time;k=null;this._useBrowserDecoding()&&(k=new N({ctx:this._context}));c={imageServiceParameters:c,nBands:Math.min(this.bandCount,3),pixelType:this.pixelType,decodeFunc:k?z.hitch(k,"decode"):null};this._rasterReadPromise=this.raster.read(c,this._requestDataHandler,this._requestDataErrorHandler)},_requestDataHandler:function(a){this._rasterReadPromise&&this._rasterReadPromise.isCanceled()||(this.originalPixelData=a,this.hasDataChanged=!0,this._setPixelData(a))},
_setPixelData:function(a){a=this._clonePixelData(a);this.pixelFilter&&this.pixelFilter(a);this.pixelData=a;this._rasterReadPromise&&this._rasterReadPromise.isCanceled()||(this._drawPixelData(),this._rasterReadPromise=null)},_clonePixelData:function(a){if(null===a||void 0===a)return a;var c={};a.extent&&(c.extent=z.clone(a.extent));a=a.pixelBlock;if(null===a||void 0===a)return c;c.pixelBlock=a.clone();return c},_setDefaultFilter:function(){},_getPixelBlockFromCanvas:function(a,c,k){a=a.getImageData(0,
0,c,k).data;var q=c*k,x=0,C=0,y=new Uint8Array(q),M=new Uint8Array(q),H=new Uint8Array(q),V=new Uint8Array(q),X=Infinity,W=Infinity,U=Infinity,Y=-Infinity,da=-Infinity,ea=-Infinity;for(x=0;x<q;x++){var fa=a[C++];var ba=a[C++];var ha=a[C++];X=X<fa?X:fa;Y=Y>fa?Y:fa;W=W<ba?W:ba;da=da>ba?da:ba;U=U<ha?U:ha;ea=ea>ha?ea:ha;y[x]=fa;M[x]=ba;H[x]=ha;V[x]=a[C++]&1}return new D({width:c,height:k,pixels:[y,M,H],pixelType:"U8",mask:V,statistics:[{minValue:X,maxValue:Y},{minValue:W,maxValue:da},{minValue:U,maxValue:ea}]})},
_useBrowserDecoding:function(){return(void 0===this.pixelFilter||null===this.pixelFilter)&&("jpeg"===this.format.toLowerCase()||"jpg"===this.format.toLowerCase()||-1<this.format.toLowerCase().indexOf("png"))},getMultidimensionalInfo:function(){var a=this._url.path+"/multiDimensionalInfo",c=new F(l._dfdCanceller);if(this._multidimensionalInfo)return c.resolve(this._multidimensionalInfo),c;!this.loaded||10.3<=this.version&&this.hasMultidimensions?(c._pendingDfd=u({url:a,content:{f:"json"},handleAs:"json",
callbackParamName:"callback"}),c._pendingDfd.then(z.hitch(this,function(k){this._multidimensionalInfo=k.multidimensionalInfo;c.callback(k.multidimensionalInfo)}),function(k){c.errback(k)})):(a=Error("Layer does not support multidimensional info"),a.log=!!d.isDebug,c.errback(a));return c},getStatistics:function(a){var c=new F(l._dfdCanceller);if(a&&this._cachedVariableStats[a])c.resolve(this._cachedVariableStats[a]);else{var k={f:"json"};a&&(k.variable=a);c._pendingDfd=u({url:this._url.path+"/statistics",
content:k,handleAs:"json",callbackParamName:"callback"});c._pendingDfd.then(z.hitch(this,function(q){q=q.statistics||q.statitsics;var x=[];q&&null!=q[0].min?q.forEach(function(C){x.push([C.min,C.max,C.mean,C.standardDeviation])}):x=q;a&&(this._cachedVariableStats.variableName=x);c.callback(x)}),function(q){c.errback(q)})}return c},getDefaultMultidimensionalDefinition:function(){var a=new F(l._dfdCanceller);if(this._defaultMultidimensionalDefinition)return a.resolve(z.clone(this._defaultMultidimensionalDefinition)),
a;a._pendingDfd=this.getMultidimensionalInfo();a._pendingDfd.then(z.hitch(this,function(c){c=this._getDefaultMultidimensionalDefinition(c);a.callback(c)}),function(c){a.errback(c)});return a},_getDefaultMultidimensionalDefinition:function(a,c,k){var q,x=[],C="",y=a.variables[0].dimensions;k&&(C=a.variables[0].name);for(q in y)y.hasOwnProperty(q)&&(c||"StdTime"!==y[q].name)&&(a=y[q],x.push(new Q({variableName:C,dimensionName:a.name,isSlice:!a.hasRanges,values:[this._getDefaultDimensionValue(a)]})));
this._defaultMultidimensionalDefinition=x;return z.clone(x)},_getDefaultDimensionValue:function(a){if(a&&a.values&&a.values.length){var c=Infinity,k;if(a.hasRanges)return a.values[0];if(a.name&&"stdz"===a.name.toLowerCase()){for(k=0;k<a.values.length;k++){var q=a.values[k];var x=Math.abs(q-0);if(x<c){c=x;var C=q}if(0===x)break}return C}return a.extent[0]}},_setDefaultMultidimensionalDefinition:function(a){var c,k={};this.getDefaultMultidimensionalDefinition().then(z.hitch(this,function(q){c=q;0<c.length&&
(this.mosaicRule?(k=z.clone(this.mosaicRule),k.multidimensionalDefinition=c):this.defaultMosaicRule?(k=z.clone(this.defaultMosaicRule),k.multidimensionalDefinition=c):k=new L({multidimensionalDefinition:c}),this.setMosaicRule(k,a))}))},_setDefaultRenderingRule:function(a){var c={},k=this.renderingRule;if(!k&&"esri.layers.ArcGISImageServiceVectorLayer"!==this.declaredClass&&!this.bandIds&&this.rasterFunctionInfos&&this.rasterFunctionInfos.length&&"none"!==this.rasterFunctionInfos[0].name.toLowerCase())c.rasterFunction=
this.rasterFunctionInfos[0].name;else if("esri.layers.ArcGISImageServiceVectorLayer"===this.declaredClass&&10.3<this.version&&(!k||"Resample"!==k.functionName)){var q="esriImageServiceDataTypeVector-UV"===this.serviceDataType?7:10;c.rasterFunction="Resample";c.rasterFunctionArguments={ResamplingType:q,InputCellSize:{x:this.pixelSizeX,y:this.pixelSizeY}};k&&(c.rasterFunctionArguments.Raster=k.toJson())}c.hasOwnProperty("rasterFunction")&&(this.defaultRenderingRule=new P(c),this.setRenderingRule(this.defaultRenderingRule,
a))},_cleanupRequestParams:function(a){if(!a)return a;if(a.time&&a.mosaicRule){var c=new L(b.fromJson(a.mosaicRule));c=this._filterOutTimeDimension(c);a.mosaicRule=b.toJson(c.toJson())}c="displayOnPan drawMode styling id opacity visible resourceInfo useMapDimensionValue extent renderer".split(" ");for(var k in c)a.hasOwnProperty(c[k])&&delete a[c[k]];return a},_filterOutTimeDimension:function(a){if(this._isMultidimensionalCRF())return a;if(a&&a.multidimensionalDefinition&&0<a.multidimensionalDefinition.length){var c=
g.filter(a.multidimensionalDefinition,function(k){return"StdTime"!==k.dimensionName});a.multidimensionalDefinition=c}return a},_removeVisualizationStretchFunction:function(a){var c=a&&a.functionName;if(!c||"stretch"!==c.toLowerCase())return a;var k=a.functionArguments.Raster;return k&&k.functionName&&g.some(this.rasterFunctionInfos,function(q){return k.functionName===q.name})?k:a},_isMultidimensionalCRF:function(){return 10.71<=this.version&&this.hasMultidimensions&&this.timeInfo&&!(this.objectIdField&&
this.fields&&1<this.fields.length)},_isTimeSupportedOnCRF:function(){return 10.8<=this.version},_cleanupMultidimensionalDefinition:function(a){a&&a.multidimensionalDefinition&&(a.multidimensionalDefinition=a.multidimensionalDefinition.filter(function(c){return!(!c.variableName&&!c.dimensionName)}),0===a.multidimensionalDefinition.length&&(a.multidimensionalDefinition=null))},_isScientificData:function(){return"esriImageServiceDataTypeVector-UV"===this.serviceDataType||"esriImageServiceDataTypeVector-MagDir"===
this.serviceDataType||"esriImageServiceDataTypeScientific"===this.serviceDataType||this.hasMultidimensions},_isVectorData:function(a){a=(a=a||this)&&a.serviceDataType;return"esriImageServiceDataTypeVector-UV"===a||"esriImageServiceDataTypeVector-MagDir"===a},_isRenderingRuleAProcessingTemplate:function(a){var c=a&&a.functionName;return!c||a.functionArguments?!1:g.some(c&&(this.rasterFunctionInfos||[]),function(k){return k&&k.name&&k.name.toLowerCase()===c.toLowerCase()})},_getRenderingRuleId:function(a){var c=
a&&a.functionName;if(c){if(this._isRenderingRuleAProcessingTemplate(a))return c;var k=this._customRenderingRuleId[c];if(k){if(k!==a){for(var q in this._customRenderingRuleId)if(this._customRenderingRuleId[q]===a)return q;for(k=0;this._customRenderingRuleId[x];)k+=1;var x;this._customRenderingRuleId[c+k]=a}}else this._customRenderingRuleId[c]=a;return c}},_createPixelData:function(a){a=new D({width:2,height:2,pixels:a,pixelType:this.pixelType,statistics:a});var c=this.fullExtent.getCenter();c=new B(c.x,
c.y,c.x+this.pixelSizeX,c.y+this.pixelSizeY,this.spatialReference);return{pixelBlock:a,extent:c}},_convertRendererToRenderingRule:function(a){var c=a&&a.declaredClass;if(!c||"esri.renderer.UniqueValueRenderer"!==c&&"esri.renderer.ClassBreaksRenderer"!==c&&"esri.renderer.StretchRenderer"!==c&&"esri.renderer.ShadedReliefRenderer"!==c&&"esri.renderer.ColormapRenderer"!==c)return null;var k=null;"esri.renderer.StretchRenderer"===c?k=a.toRenderingRule({convertToColormap:10.6>this.version}):"esri.renderer.ClassBreaksRenderer"===
c?k=this._convertClassifyRenderer(a):"esri.renderer.UniqueValueRenderer"===c?k=this._convertUniqueValueRenderer(a):"esri.renderer.ShadedReliefRenderer"===c?k=this._convertShadedReliefRenderer(a):"esri.renderer.ColormapRenderer"===c&&(k=this._convertColormapRenderer(a));return k},_getValueField:function(a){if(a&&a.length){var c,k;g.some(a,function(q){if((k=q.name)&&"value"===k.toLowerCase())return c=k,!0});return c}},_convertColormapRenderer:function(a){var c=new P;c.functionName="Colormap";c.functionArguments=
{};a=a.colormapInfos.map(function(k){return[k.value].concat(k.color)});c.functionArguments.Colormap=a;return c},_convertShadedReliefRenderer:function(a){var c=new P;c.functionName="Hillshade";var k="traditional"===a.hillshadeType?0:1,q="none"===a.scalingType?1:3,x={HillshadeType:k,SlopeType:q,ZFactor:a.zFactor};0===k&&(x.Azimuth=a.azimuth,x.Altitude=a.altitude);3===q&&(x.PSPower=a.pixelSizePower,x.PSZFactor=a.pixelSizeFactor);c.functionArguments=x;c.variableName="Raster";a.colorRamp&&(c.functionName=
"ShadedRelief",x.Colormap=S.convertColorRampToColormap(a.colorRamp,256));return c},_convertClassifyRenderer:function(a){var c=[],k=[],q=[],x=[],C;var y=this.renderingRule&&this._getRenderingRuleId(this.renderingRule);var M=this.hasRasterAttributeTable;if(y){M=this._rasterFunctionTemplateInfos[y]?this._rasterFunctionTemplateInfos[y].hasRasterAttributeTable:this.hasRasterAttributeTable;var H=this._renderingRuleAttributeTable[y];var V=this._rasterFunctionTemplateInfos[y]}var X=H&&H.features?H.features:
this._rasterAttributeTableFeatures;var W=this._getValueField(H&&H.fields?H.fields:this._rasterAttributeTableFields);M&&X?(g.forEach(a.infos,function(U,Y){var da,ea=U.symbol.color;ea.a&&g.forEach(X,function(fa){da=fa.attributes[a.attributeField];(da>=U.minValue&&da<U.maxValue||Y===a.infos.length-1&&da>=U.minValue)&&x.push([fa.attributes[W],ea.r,ea.g,ea.b])},this)},this),y=V&&V.pixelType||this.pixelType,this._adjustColormapToPixelTypeRange(x,y),y=new P,y.functionName="Colormap",y.functionArguments=
{},y.functionArguments.Colormap=x,y.variableName="Raster"):(g.forEach(a.infos,function(U,Y){C=U.symbol&&U.symbol.color;C.a?(0===Y?c.push.call(c,U.minValue,U.maxValue+1E-4):c.push.call(c,U.minValue+1E-4,U.maxValue+1E-4),k.push(Y),x.push([Y,C.r,C.g,C.b])):q.push(U.minValue,U.maxValue)}),y=V&&V.pixelType||this.pixelType,this._adjustColormapToPixelTypeRange(x,y),y=new P,y.functionName="Remap",y.functionArguments={InputRanges:c,OutputValues:k,NoDataRanges:q},y.variableName="Raster",H=new P,H.functionName=
"Colormap",H.functionArguments={Colormap:x,Raster:y},y=H);return y},_convertUniqueValueRenderer:function(a){var c=[],k=this.renderingRule&&this._getRenderingRuleId(this.renderingRule);if(k){var q=this._renderingRuleAttributeTable[k];var x=this._rasterFunctionTemplateInfos[k]}var C=q&&q.features?q.features:this._rasterAttributeTableFeatures;var y=(k=q&&q.fields?q.fields:this._rasterAttributeTableFields)&&k.length?this._getValueField(k):"Value";g.forEach(a.infos,function(M){var H=M.symbol.color;H.a&&
(a.attributeField!==y&&C?g.forEach(C,function(V){V.attributes[a.attributeField]==M.value&&c.push([V.attributes[y],H.r,H.g,H.b])},this):c.push([M.value,H.r,H.g,H.b]))},this);this._adjustColormapToPixelTypeRange(c,x&&x.pixelType||this.pixelType);x=new P;x.functionName="Colormap";x.functionArguments={};x.functionArguments.Colormap=c;x.variableName="Raster";return x},_adjustColormapToPixelTypeRange:function(a,c){(c=this._pixelTypeRanges[c])&&a.push([Math.floor(c[0]-1),0,0,0],[Math.ceil(c[1]+1),0,0,0]);
return a},_combineRenderingRule:function(a,c){if(!a||!c)return a||c;var k=function(q){var x=q.Raster;return x=x&&"esri.layers.RasterFunction"===x.declaredClass?k(x.functionArguments):q};a=z.clone(a);"none"!==c.functionName.toLocaleLowerCase()&&(k(a.functionArguments).Raster=c);return a},_isItemLevelRasterFunction:function(a){var c=a&&a.functionName;if(!c||!this._hasItemLevelRFT)return!1;var k=!1;g.some(this.rasterFunctionInfos,function(q){if(q&&q.name===c){if(1===q.functionType||2===q.functionType)k=
!0;return!0}});return k},_getServiceLevelRenderingRule:function(a){if(!this._hasItemLevelRFT||!a)return a;a=new P(a.toJson());var c=a.functionArguments;for(var k;;)if((k=c&&c.Raster)&&k.functionArguments&&k.functionArguments.Raster)c=k,c=c.functionArguments;else{this._isItemLevelRasterFunction(k)&&delete c.Raster;break}return a},_getItemLevelRenderingRule:function(a){if(!this._hasItemLevelRFT||!a)return null;if(this._isItemLevelRasterFunction(a))return a;a=new P(a.toJson());for(a=a.functionArguments;;)if((a=
a&&a.Raster)&&a.functionArguments&&a.functionArguments.Raster)a=a.functionArguments;else{if(this._isItemLevelRasterFunction(a))return a;break}},_resolve:function(a,c,k,q,x){c&&this[c].apply(this,a);k&&k.apply(null,a);q&&l._resDfd(q,a,x)},_toggleTime:function(){var a=this._map;this.timeInfo&&this.useMapTime&&a&&!this.suspended?(this._timeConnect||(this._timeConnect=f.connect(a,"onTimeExtentChange",this,this._onTimeExtentChangeHandler)),this._setTime(a.timeExtent)):(f.disconnect(this._timeConnect),
this._timeConnect=null,this._setTime(null))},setUseMapTime:function(a,c){this.useMapTime=a;this._toggleTime();!c&&this._map&&this.refresh(!0)},_setTime:function(a){this._params&&(this._params.time=a?a.toJson().join(","):null)},_onTimeExtentChangeHandler:function(a){this.suspended||(this._setTime(a),this.refresh(!0))},handleSpatialReferenceChange:function(){this.onSpatialReferenceChange()},getColormap:function(a){var c=this._url.path+"/colormap",k=new F(l._dfdCanceller),q={f:"json"};a&&a.renderingRule&&
(q.renderingRule=b.toJson(a.renderingRule.toJson()));this.hasColormap?(k._pendingDfd=u({url:c,content:q,handleAs:"json",callbackParamName:"callback"}),k._pendingDfd.then(function(x){k.callback(x)},function(x){k.errback(x)})):(a=Error("Layer does not support colormap"),a.log=!!d.isDebug,k.errback(a));return k},getRenderingRuleColormap:function(a){var c=new F(l._dfdCanceller);if(!a||!a.renderingRule)return c.errback(Error("Rendering rule is not specified")),c;a=a.renderingRule;var k=this._getRenderingRuleId(a);
this._renderingRuleColormap&&k&&this._renderingRuleColormap.hasOwnProperty(k)?c.resolve(this._renderingRuleColormap[k]):c=this.getColormap({renderingRule:a}).then(z.hitch(this,function(q){q=q&&q.colormap;k&&(this._renderingRuleColormap[k]=q);return q}));return c}});e("extend-esri")&&z.setObject("layers.ImageServiceLayerMixin",J,r);return J})},"esri/layers/MosaicRule":function(){define("dojo/_base/declare dojo/_base/lang dojo/has ../kernel ../lang ../geometry/Point ./RasterFunction".split(" "),function(J,
z,F,g,b,d,f){var e=J(null,{declaredClass:"esri.layers.MosaicRule",method:null,where:null,sortField:null,sortValue:null,ascending:!1,lockRasterIds:null,viewpoint:null,objectIds:null,operation:null,multidimensionalDefinition:[],itemRenderingRule:null,constructor:function(h){z.isObject(h)&&(z.mixin(this,h),h.mosaicMethod&&(this.method=h.mosaicMethod),this.method&&"esri"!==this.method.toLowerCase().substring(0,4)&&(this.method=this._getMethodEnum(this.method)),h.mosaicOperation&&(this.operation=h.mosaicOperation),
this.operation&&"MT_"!==this.operation.toUpperCase().substring(0,3)&&(this.operation=this._getOperatorEnum(this.operation)),h.fids&&(this.objectIds=h.fids),h.viewpoint&&(this.viewpoint=new d(h.viewpoint)),h.itemRenderingRule&&(this.itemRenderingRule=new f(h.itemRenderingRule)),this.multidimensionalDefinition=h.multidimensionalDefinition||[])},toJson:function(){var h=null,n=this.multidimensionalDefinition?this.multidimensionalDefinition.length:0;if(n){h=[];for(var r=0;r<n;r++)h.push("esri.layers.DimensionalDefinition"===
this.multidimensionalDefinition[r].declaredClass?this.multidimensionalDefinition[r].toJson():this.multidimensionalDefinition[r])}h={mosaicMethod:this.method,where:this.where,sortField:this.sortField,sortValue:this.sortValue,ascending:this.ascending,lockRasterIds:z.clone(this.lockRasterIds),viewpoint:this.viewpoint?this.viewpoint.toJson():null,fids:z.clone(this.objectIds),mosaicOperation:this.operation,multidimensionalDefinition:h,itemRenderingRule:this.itemRenderingRule?this.itemRenderingRule.toJson():
null};return b.filter(h,function(m){if(null!==m)return!0})},_getMethodEnum:function(h){if(h){var n=e.METHOD_NONE;switch(h.toLowerCase()){case "byattribute":n=e.METHOD_ATTRIBUTE;break;case "center":n=e.METHOD_CENTER;break;case "lockraster":n=e.METHOD_LOCKRASTER;break;case "nadir":n=e.METHOD_NADIR;break;case "northwest":n=e.METHOD_NORTHWEST;break;case "seamline":n=e.METHOD_SEAMLINE;break;case "viewpoint":n=e.METHOD_VIEWPOINT}return n}},_getOperatorEnum:function(h){if(h)switch(h.toLowerCase()){case "first":return e.OPERATION_FIRST;
case "last":return e.OPERATION_LAST;case "max":return e.OPERATION_MAX;case "min":return e.OPERATION_MIN;case "blend":return e.OPERATION_BLEND;case "mean":return e.OPERATION_MEAN;case "sum":return e.OPERATION_SUM}}});z.mixin(e,{METHOD_NONE:"esriMosaicNone",METHOD_CENTER:"esriMosaicCenter",METHOD_NADIR:"esriMosaicNadir",METHOD_VIEWPOINT:"esriMosaicViewpoint",METHOD_ATTRIBUTE:"esriMosaicAttribute",METHOD_LOCKRASTER:"esriMosaicLockRaster",METHOD_NORTHWEST:"esriMosaicNorthwest",METHOD_SEAMLINE:"esriMosaicSeamline",
OPERATION_FIRST:"MT_FIRST",OPERATION_LAST:"MT_LAST",OPERATION_MIN:"MT_MIN",OPERATION_MAX:"MT_MAX",OPERATION_MEAN:"MT_MEAN",OPERATION_BLEND:"MT_BLEND",OPERATION_SUM:"MT_SUM"});F("extend-esri")&&z.setObject("layers.MosaicRule",e,g);return e})},"esri/layers/DimensionalDefinition":function(){define(["dojo/_base/declare","dojo/_base/lang","dojo/has","../kernel","../lang"],function(J,z,F,g,b){J=J(null,{declaredClass:"esri.layers.DimensionalDefinition",variableName:null,dimensionName:null,values:[],isSlice:!1,
constructor:function(d){z.isObject(d)&&z.mixin(this,d)},toJson:function(){var d={variableName:this.variableName,dimensionName:this.dimensionName,values:z.clone(this.values),isSlice:this.isSlice};return b.filter(d,function(f){return null!==f})}});F("extend-esri")&&z.setObject("layers.DimensionalDefinition",J,g);return J})},"esri/layers/Raster":function(){define("require dojo/_base/declare dojo/_base/lang dojo/_base/Deferred dojo/_base/array dojo/_base/config dojo/json dojo/sniff ../kernel ../Evented ../request ../geometry/Extent ../SpatialReference ../deferredUtils ./PixelBlock ./rasterFormats/LercCodec ./rasterFormats/Lerc2Codec".split(" "),
function(J,z,F,g,b,d,f,e,h,n,r,m,w,u,l,v,B){var K,I,S,L,P,Q;z=z(n,{declaredClass:"esri.layers.Raster",imageServiceUrl:null,validPixelTypes:"U1 U2 U4 U8 U16 U32 S8 S16 S32 F32".split(" "),validFormats:"lerc jpeg jpg jpgpng png png8 png24 png32 bip bsq tiff".split(" "),_eventMap:{"raster-read-complete":["pixelData","params"]},constructor:function(p){this.imageServiceUrl=p;this.registerConnectEvents();this._loadRasterFormatModules()},read:function(p,t,E){var G=this,A=new g(u._dfdCanceller);if(10>e("ie"))throw"This browser is not supported.";
if(!p.imageServiceParameters)throw"Insufficient parameters to read data";var a=F.clone(p.imageServiceParameters),c=p.pixelType;b.some(this.validPixelTypes,function(M){return M===c})||(a.pixelType="F32");b.some(this.validFormats,function(M){return M.toLowerCase()===a.format.toLowerCase()})||(a.format="lerc");var k=p.decodeFunc,q;this._prepareGetImageParameters(a);var x=a.width,C=a.height,y=a.extent;delete a.width;delete a.height;delete a.extent;A._pendingDfd=r({url:this.imageServiceUrl+"/exportImage",
handleAs:"arraybuffer",content:F.mixin(a,{f:"image"}),load:function(M){G.decode(M,{width:x,height:C,planes:null,pixelType:c,noDataValue:a.noData,format:a.format,decodeFunc:k}).then(function(H){q={pixelBlock:H,extent:y};G._resolve([q,a],"onRasterReadComplete",t,A)},function(H){G._resolve([H],null,E,A,!0)})},error:function(M){G._resolve([M],null,E,A,!0)}});return A.promise},decode:function(p,t){if(void 0===t||null===t)throw"missing decode options";var E;t.format&&(E=t.format.toUpperCase());"BSQ"!==
E&&"BIP"!==E&&(E=this._getFormat(p));var G=t.decodeFunc;if(void 0===G||null===G)G=this._getFormatDecoderDfd(E);return G(p,t)},onRasterReadComplete:function(){},_prepareGetImageParameters:function(p){if(p.size&&p.bbox){var t=p.size.split(",");p.width=parseFloat(t[0]);p.height=parseFloat(t[1]);p.extent||(t=p.bbox.split(","),p.extent=new m(parseFloat(t[0]),parseFloat(t[1]),parseFloat(t[2]),parseFloat(t[3]),new w(p.bboxSR)))}else{if(!p.width||Math.floor(p.width)!==p.width||!p.height||Math.floor(p.height)!==
p.height)throw"Incorrect Image Dimensions";if(!p.extent||"esri.geometry.Extent"!==p.extent.declaredClass)throw"Incorrect extent";t=p.extent;var E=t.spatialReference.wkid||f.toJson(t.spatialReference.toJson());delete p._ts;F.mixin(p,{bbox:t.xmin+","+t.ymin+","+t.xmax+","+t.ymax,imageSR:E,bboxSR:E,size:p.width+","+p.height},p.disableClientCaching?{_ts:(new Date).getTime()}:{})}},_adjustExtent:function(p,t,E){var G=p.ymax-p.ymin,A=p.xmax-p.xmin;E>=t?p.ymax=p.ymin+A*t/E:p.xmax=p.xmin+G*E/t;return p},
_resolve:function(p,t,E,G,A){t&&this[t].apply(this,p);E&&E.apply(null,p);G&&u._resDfd(G,p,A)},_getFormatDecoderDfd:function(p){var t=null;switch(p){case "LERC":t=this._decodeLerc;break;case "LERC2":t=this._decodeLerc2;break;case "JPEG":t=this._decodeJpeg;break;case "PNG":t=this._decodePng;break;case "BSQ":t=this._decodeBsq;break;case "BIP":t=this._decodeBip;break;case "TIFF":t=this._decodeTiff;break;default:t=function(E,G){throw"The raster format is not supported";}}t=F.hitch(this,t);return function(E,
G){var A=new g;try{if("LERC"===p||!0===P){var a=t(E,G);A.resolve(a)}else Q.then(function(){a=t(E,G);A.resolve(a)})}catch(c){A.reject(c)}return A}},_getFormat:function(p){p=new Uint8Array(p,0,10);var t="";if(255===p[0]&&216===p[1])t="JPEG";else if(137===p[0]&&80===p[1]&&78===p[2]&&71===p[3])t="PNG";else if(67===p[0]&&110===p[1]&&116===p[2]&&90===p[3]&&73===p[4]&&109===p[5]&&97===p[6]&&103===p[7]&&101===p[8]&&32===p[9])t="LERC";else if(76===p[0]&&101===p[1]&&114===p[2]&&99===p[3]&&50===p[4]&&32===p[5])t=
"LERC2";else if(-1<String.fromCharCode.apply(null,p).toLowerCase().indexOf("error"))t="ERROR";else if(73===p[0]&&73===p[1]&&42===p[2]&&0===p[3]||77===p[0]&&77===p[1]&&0===p[2]&&42===p[3])t="TIFF";return t},_validateDecodeParams:function(p){if(!p.height||Math.floor(p.height)!==p.height)throw"Height not provided.";if(!p.width||Math.floor(p.width)!==p.width)throw"Width not provided.";},_decodeJpeg:function(p,t){if(!K)throw"The jpeg decoder module is not loaded.";this._validateDecodeParams(t);p=(new K).decode(p);
if(!N(p,t))throw"The decoded image dimensions are incorrect.";t=[];var E;for(E=0;E<p.pixels.length;E++){var G=p.pixels[E];t.push(this._calculateBandStatistics(G))}return new l({width:p.width,height:p.height,pixels:p.pixels,pixelType:"U8",mask:p.mask,statistics:t})},_decodePng:function(p,t){if(!I)throw"The png decoder module is not loaded.";this._validateDecodeParams(t);p=new Uint8Array(p);var E=new I(p);p=new Uint8Array(t.width*t.height*4);E.copyToImageData(p,E.decodePixels());var G=E=0;G=new Uint8Array(t.width*
t.height);for(E=0;E<t.width*t.height;E++)G[E]=p[4*E+3];var A=new l({width:t.width,height:t.height,pixels:[],pixelType:"U8",mask:G,statistics:[]});for(E=0;3>E;E++){var a=new Uint8Array(t.width*t.height);for(G=0;G<t.width*t.height;G++)a[G]=p[4*G+E];A.addData({pixels:a,statistics:this._calculateBandStatistics(a)})}return A},_decodeBsq:function(p,t){if(!S)throw"The bsq decoder module is not loaded.";this._validateDecodeParams(t);D=t.noDataValue;t.pixelType=O(t.pixelType);p=S.decodeBSQ(p,{bandCount:t.planes,
width:t.width,height:t.height,pixelType:R,noDataValue:D});var E=[],G,A=null;for(G=0;G<p.pixels.length;G++)A=p.pixels[G],E.push(this._calculateBandStatistics(A));return new l({width:t.width,height:t.height,pixels:p.pixels,pixelType:t.pixelType,mask:p.maskData,statistics:E})},_decodeBip:function(p,t){this._validateDecodeParams(t);D=t.noDataValue;t.pixelType=O(t.pixelType);p=S.decodeBIP(p,{bandCount:t.planes,width:t.width,height:t.height,pixelType:R,noDataValue:D});var E=[],G,A=null;for(G=0;G<p.pixels.length;G++)A=
p.pixels[G],E.push(this._calculateBandStatistics(A));return new l({width:t.width,height:t.height,pixels:p.pixels,pixelType:t.pixelType,mask:p.maskData,statistics:E})},_decodeTiff:function(p,t){this._validateDecodeParams(t);D=t.noDataValue;t.pixelType=O(t.pixelType);p=L.decode(p);t=[];var E,G=null;for(E=0;E<p.pixels.length;E++)G=p.pixels[E],t.push(this._calculateBandStatistics(G,p.maskData));return new l({width:p.width,height:p.height,pixels:p.pixels,pixelType:p.pixelType,mask:p.maskData,statistics:t})},
_decodeLerc:function(p,t){this._validateDecodeParams(t);D=t.noDataValue;t.pixelType=O(t.pixelType);for(var E=0,G,A=0,a,c=p.byteLength-10;A<c;){var k=v.decode(p,{inputOffset:A,encodedMaskData:G,returnMask:0===E?!0:!1,returnEncodedMask:0===E?!0:!1,returnFileInfo:!0,pixelType:R,noDataValue:D});A=k.fileInfo.eofOffset;0===E&&(G=k.encodedMaskData,a=new l({width:t.width,height:t.height,pixels:[],pixelType:t.pixelType,mask:k.maskData,statistics:[]}));E++;if(!N(k,t))throw"The decoded image dimensions are incorrect";
a.addData({pixels:k.pixelData,statistics:{minValue:k.minValue,maxValue:k.maxValue,noDataValue:k.noDataValue}})}return a},_decodeLerc2:function(p,t){this._validateDecodeParams(t);D=t.noDataValue;t.pixelType=O(t.pixelType);for(var E=0,G,A,a=0,c,k=p.byteLength-10,q=[];a<k;){A=B.decode(p,{inputOffset:a,maskData:G,returnFileInfo:!0});a=A.fileInfo.eofOffset;0===E&&(G=A.maskData,c=new l({width:t.width,height:t.height,pixels:[],pixelType:A.fileInfo.pixelType,mask:A.maskData,statistics:[]}));A.fileInfo.mask&&
0<A.fileInfo.mask.numBytes&&q.push(A.maskData);E++;if(!N(A,t))throw"The decoded image dimensions are incorrect";if(1<A.dimCount&&A.pixelData&&A.pixelData.length===A.width*A.height*A.dimCount){A.pixelData=A.pixelData.slice(-A.width*A.height);var x=A.dimStats&&A.dimStats.minValues&&A.dimStats.minValues[A.dimCount-1],C=A.dimStats&&A.dimStats.maxValues&&A.dimStats.maxValues[A.dimCount-1];null!=x&&null!=C&&(A.minValue=x,A.maxValue=C)}c.addData({pixels:A.pixelData,statistics:{minValue:A.minValue,maxValue:A.maxValue,
noDataValue:A.noDataValue}})}if(1<q.length){A=c.width*c.height;c.bandMasks=q;G=new Uint8Array(A);G.set(q[0]);for(t=1;t<q.length;t++)for(p=q[t],E=0;E<A;E++)G[E]&=p[E];c.maskData=G}return c},_calculateBandStatistics:function(p,t){var E=Infinity,G=-Infinity,A=p.length,a,c=0;if(t)for(a=0;a<A;a++)t[a]&&(c=p[a],E=c<E?c:E,G=c>G?c:G);else for(a=0;a<A;a++)c=p[a],E=c<E?c:E,G=c>G?c:G;return{minValue:E,maxValue:G}},_loadRasterFormatModules:function(){P||(Q||(Q=new g),10>e("ie")?Q.isRejected()||Q.reject("unsupported browser version"):
J(["./rasterFormats/JpgPlus","./rasterFormats/Png","./rasterFormats/Raw","./rasterFormats/TiffDecoder","./rasterFormats/Zlib"],function(p,t,E,G){K=p;I=t;S=E;L=G;P=!0;Q.isResolved()||Q.resolve(!0)}))}});var R=null,D=null,O=function(p){if("U1"===p||"U2"===p||"U4"===p||"U8"===p)return D=Math.pow(2,8)-1,R=Uint8Array,"U8";"U16"===p?(D=D||Math.pow(2,16)-1,R=Uint16Array):"U32"===p?(D=D||Math.pow(2,32)-1,R=Uint32Array):"S8"===p?(D=D||0-Math.pow(2,7),R=Int8Array):"S16"===p?(D=D||0-Math.pow(2,15),R=Int16Array):
"S32"===p?(D=D||0-Math.pow(2,31),R=Int32Array):R=Float32Array;return p},N=function(p,t){return p.height!==t.height||p.width!==t.width?!1:!0};e("extend-esri")&&F.setObject("layers.Raster",z,h);return z})},"esri/layers/PixelBlock":function(){define(["dojo/_base/declare","dojo/_base/lang","dojo/has","../kernel"],function(J,z,F,g){J=J([],{declaredClass:"esri.layers.PixelBlock",planes:null,width:null,height:null,pixelType:null,pixels:[],statistics:[],maskIsAlpha:!1,validPixelCount:null,constructor:function(b){if(b){if(!b.width||
Math.floor(b.width)!==b.width)throw"PixelBlock: incorrect width";if(!b.height||Math.floor(b.height)!==b.height)throw"PixelBlock: incorrect height";if(!b.pixels)throw"PixelBlock: pixel data not present";this.width=b.width;this.height=b.height;this.pixels=b.pixels;this.pixelType=b.pixelType||null;this.statistics=b.statistics;this.mask=b.mask||null;this.maskIsAlpha=b.maskIsAlpha||!1;b=b.validPixelCount;null==b&&(b=this.mask?this._getValidPixelCount(this.mask):this.width*this.height);this.validPixelCount=
b}},getPlaneCount:function(){return this.pixels.length!==this.statistics.length?console.error("Inconsistent pixel data and statistics"):this.statistics.length},addData:function(b){if(!b.pixels||!b.statistics)throw"Pixel data or statistics are not present";if(b.pixels.length!==this.width*this.height)throw"Inconsistent pixel data size";this.statistics.push(b.statistics);this.pixels.push(b.pixels)},getAsRGBA:function(){var b=new ArrayBuffer(this.width*this.height*4);switch(this.pixelType){case "S8":case "S16":case "U16":case "S32":case "U32":case "F32":case "F64":this._fillFromNon8Bit(b);
break;default:this._fillFrom8Bit(b)}return new Uint8ClampedArray(b)},getAsRGBAFloat:function(){var b=new Float32Array(this.width*this.height*4);this._fillFrom32Bit(b);return b},clone:function(b){b=b||this;var d=new this.constructor;d.width=b.width;d.height=b.height;d.pixelType=b.pixelType;d.maskIsAlpha=b.maskIsAlpha;b.mask&&(d.mask=new Uint8Array(b.mask));var f,e;if(b.pixels){d.pixels=[];var h=(e=b.pixels.length)&&b.pixels[0].slice;for(f=0;f<e;f++)d.pixels[f]=h?b.pixels[f].slice(0,b.pixels[f].length):
new b.pixels[f].constructor(b.pixels[f])}if(b.statistics)for(d.statistics=[],e=b.statistics.length,f=0;f<e;f++)d.statistics[f]=z.clone(b.statistics[f]);b=b.validPixelCount;null==b&&(b=d.mask?this._getValidPixelCount(d.mask):d.width*d.height);return d},clamp:function(b){if("F64"!==b&&"F32"!==b){switch(b){case "U8":var d=[0,255];break;case "U16":d=[0,65535];break;case "U32":d=[0,4294967295];break;case "S8":d=[-128,127];break;case "S16":d=[-32768,32767];break;case "S32":d=[-2147483648,2147483647];break;
default:d=[-3.4*1E39,3.4*1E39]}var f=d[0];d=d[1];var e=this.pixels,h=this.width*this.height,n=e.length,r,m,w=[];for(r=0;r<n;r++){var u=this._createEmptyBand(b,h);var l=e[r];for(m=0;m<h;m++){var v=l[m];u[m]=v>d?d:v<f?f:v}w.push(u)}this.pixels=w;this.pixelType=b}},calculateStatistics:function(){var b,d=[],f=this.mask;for(b=0;b<this.pixels.length;b++){var e=this.pixels[b];d.push(this._calculateBandStatistics(e,f))}this.statistics=d},_getValidPixelCount:function(b){var d,f=0;for(d=0;d<b.length;d++)b[d]&&
f++;return f},_createEmptyBand:function(b,d){switch(b){case "U8":b=new Uint8Array(d);break;case "U16":b=new Uint16Array(d);break;case "U32":b=new Uint32Array(d);break;case "S8":b=new Int8Array(d);break;case "S16":b=new Int16Array(d);break;case "S32":b=new Int32Array(d);break;case "U32":b=new Uint32Array(d);break;case "F32":b=new Float32Array(d);break;case "F64":b=new Float64Array(d);break;default:b=new Float32Array(d)}return b},_fillFrom8Bit:function(b){var d=this.pixels,f=this.mask;if(!b||!d||!d.length)return console.error("Unable to convert to RGBA. The input pixel block is empty.");
var e,h;var n=e=h=d[0];3<=d.length&&(e=d[1],h=d[2]);d=new Uint32Array(b);var r=this.width*this.height;if(n.length!==r)return console.error("Unable to convert to RGBA. The pixelblock is invalid.");if(f&&f.length===r)if(this.maskIsAlpha)for(b=0;b<r;b++)f[b]&&(d[b]=f[b]<<24|h[b]<<16|e[b]<<8|n[b]);else for(b=0;b<r;b++)f[b]&&(d[b]=-16777216|h[b]<<16|e[b]<<8|n[b]);else for(b=0;b<r;b++)d[b]=-16777216|h[b]<<16|e[b]<<8|n[b]},_fillFromNon8Bit:function(b){var d=this.pixels,f=this.mask,e=this.statistics;if(!b||
!d||!d.length)return console.error("Unable to convert to RGBA. The input pixel block is empty.");var h=1,n=0;h=1;e&&0<e.length?(n=e.map(function(u){return u.minValue}).reduce(function(u,l){return Math.min(u,l)}),h=e.map(function(u){return u.maxValue-u.minValue}).reduce(function(u,l){return Math.max(u,l)}),h=255/h):(h=255,"S8"===this.pixelType?(n=-128,h=127):"U16"===this.pixelType?h=65535:"S16"===this.pixelType?(n=-32768,h=32767):"U32"===this.pixelType?h=4294967295:"S32"===this.pixelType?(n=-2147483648,
h=2147483647):"F32"===this.pixelType?(n=-3.4*1E39,h=3.4*1E39):"F64"===this.pixelType&&(n=-Number.MAX_VALUE,h=Number.MAX_VALUE),h=255/(h-n));b=new Uint32Array(b);e=this.width*this.height;var r=d[0];if(r.length!==e)return console.error("Unable to convert to RGBA. The pixelblock is invalid.");if(3<=d.length){var m=d[1];var w=d[2];if(f&&f.length===e)for(d=0;d<e;d++)f[d]&&(b[d]=-16777216|(w[d]-n)*h<<16|(m[d]-n)*h<<8|(r[d]-n)*h);else for(d=0;d<e;d++)b[d]=-16777216|(w[d]-n)*h<<16|(m[d]-n)*h<<8|(r[d]-n)*
h}else if(f&&f.length===e)for(d=0;d<e;d++)m=(r[d]-n)*h,f[d]&&(b[d]=-16777216|m<<16|m<<8|m);else for(d=0;d<e;d++)m=(r[d]-n)*h,b[d]=-16777216|m<<16|m<<8|m},_fillFrom32Bit:function(b){var d=this.pixels,f=this.mask;if(!b||!d||!d.length)return console.error("Unable to convert to RGBA. The input pixel block is empty.");var e,h;var n=e=h=d[0];3<=d.length&&(e=d[1],h=d[2]);var r=this.width*this.height;if(n.length!==r)return console.error("Unable to convert to RGBA. The pixelblock is invalid.");var m=0;if(f&&
f.length===r)for(d=0;d<r;d++)b[m++]=n[d],b[m++]=e[d],b[m++]=h[d],b[m++]=f[d]&1;else for(d=0;d<r;d++)b[m++]=n[d],b[m++]=e[d],b[m++]=h[d],b[m++]=1},_calculateBandStatistics:function(b,d){var f=Infinity,e=-Infinity,h=b.length,n,r=0;if(d)for(n=0;n<h;n++)d[n]&&(r=b[n],f=r<f?r:f,e=r>e?r:e);else for(n=0;n<h;n++)r=b[n],f=r<f?r:f,e=r>e?r:e;return{minValue:f,maxValue:e}}});F("extend-esri")&&z.setObject("layers.PixelBlock",J,g);return J})},"esri/layers/rasterFormats/LercCodec":function(){define([],function(){var J=
{defaultNoDataValue:-3.4027999387901484E38,decode:function(F,g){g=g||{};var b=g.inputOffset||0,d=g.encodedMaskData||null===g.encodedMaskData,f={},e=new Uint8Array(F,b,10);f.fileIdentifierString=String.fromCharCode.apply(null,e);if("CntZImage"!=f.fileIdentifierString.trim())throw"Unexpected file identifier string: "+f.fileIdentifierString;b+=10;e=new DataView(F,b,24);f.fileVersion=e.getInt32(0,!0);f.imageType=e.getInt32(4,!0);f.height=e.getUint32(8,!0);f.width=e.getUint32(12,!0);f.maxZError=e.getFloat64(16,
!0);b+=24;if(!d)if(e=new DataView(F,b,16),f.mask={},f.mask.numBlocksY=e.getUint32(0,!0),f.mask.numBlocksX=e.getUint32(4,!0),f.mask.numBytes=e.getUint32(8,!0),f.mask.maxValue=e.getFloat32(12,!0),b+=16,0<f.mask.numBytes){d=new Uint8Array(Math.ceil(f.width*f.height/8));e=new DataView(F,b,f.mask.numBytes);var h=e.getInt16(0,!0),n=2,r=0;do{if(0<h)for(;h--;)d[r++]=e.getUint8(n++);else{var m=e.getUint8(n++);for(h=-h;h--;)d[r++]=m}h=e.getInt16(n,!0);n+=2}while(n<f.mask.numBytes);if(-32768!==h||r<d.length)throw"Unexpected end of mask RLE encoding";
f.mask.bitset=d;b+=f.mask.numBytes}else 0===(f.mask.numBytes|f.mask.numBlocksY|f.mask.maxValue)&&(d=new Uint8Array(Math.ceil(f.width*f.height/8)),f.mask.bitset=d);e=new DataView(F,b,16);f.pixels={};f.pixels.numBlocksY=e.getUint32(0,!0);f.pixels.numBlocksX=e.getUint32(4,!0);f.pixels.numBytes=e.getUint32(8,!0);f.pixels.maxValue=e.getFloat32(12,!0);b+=16;d=f.pixels.numBlocksX;e=f.pixels.numBlocksY;d+=0<f.width%d?1:0;h=e+(0<f.height%e?1:0);f.pixels.blocks=Array(d*h);for(r=n=0;r<h;r++)for(m=0;m<d;m++){var w=
0;e=new DataView(F,b,Math.min(10,F.byteLength-b));var u={};f.pixels.blocks[n++]=u;var l=e.getUint8(0);w++;u.encoding=l&63;if(3<u.encoding)throw"Invalid block encoding ("+u.encoding+")";if(2===u.encoding)b++;else{if(0!==l&&2!==l){l>>=6;u.offsetType=l;if(2===l)u.offset=e.getInt8(1),w++;else if(1===l)u.offset=e.getInt16(1,!0),w+=2;else if(0===l)u.offset=e.getFloat32(1,!0),w+=4;else throw"Invalid block offset type";if(1===u.encoding)if(l=e.getUint8(w),w++,u.bitsPerPixel=l&63,l>>=6,u.numValidPixelsType=
l,2===l)u.numValidPixels=e.getUint8(w),w++;else if(1===l)u.numValidPixels=e.getUint16(w,!0),w+=2;else if(0===l)u.numValidPixels=e.getUint32(w,!0),w+=4;else throw"Invalid valid pixel count type";}b+=w;if(3!=u.encoding)if(0===u.encoding){l=(f.pixels.numBytes-1)/4;if(l!==Math.floor(l))throw"uncompressed block has invalid length";e=new ArrayBuffer(4*l);w=new Uint8Array(e);w.set(new Uint8Array(F,b,4*l));e=new Float32Array(e);u.rawData=e;b+=4*l}else 1===u.encoding&&(l=Math.ceil(u.numValidPixels*u.bitsPerPixel/
8),e=new ArrayBuffer(4*Math.ceil(l/4)),w=new Uint8Array(e),w.set(new Uint8Array(F,b,l)),u.stuffedData=new Uint32Array(e),b+=l)}}f.eofOffset=b;F=null!=g.noDataValue?g.noDataValue:J.defaultNoDataValue;d=g.encodedMaskData;l=g.returnMask;h=0;n=f.pixels.numBlocksX;r=f.pixels.numBlocksY;m=Math.floor(f.width/n);u=Math.floor(f.height/r);w=2*f.maxZError;b=Number.MAX_VALUE;d=d||(f.mask?f.mask.bitset:null);var v;e=new (g.pixelType||Float32Array)(f.width*f.height);l&&d&&(v=new Uint8Array(f.width*f.height));l=
new Float32Array(m*u);for(var B,K,I=0;I<=r;I++){var S=I!==r?u:f.height%r;if(0!==S)for(var L=0;L<=n;L++){var P=L!==n?m:f.width%n;if(0!==P){var Q=I*f.width*u+L*m,R=f.width-P,D=f.pixels.blocks[h],O;if(2>D.encoding){if(0===D.encoding)var N=D.rawData;else{var p=O=N=void 0;B=D.stuffedData;K=D.bitsPerPixel;var t=D.numValidPixels,E=D.offset,G=w,A=l,a=f.pixels.maxValue,c=(1<<K)-1,k=0,q=0,x=Math.ceil((a-E)/G);B[B.length-1]<<=8*(4*B.length-Math.ceil(K*t/8));for(p=0;p<t;p++)0===q&&(N=B[k++],q=32),q>=K?(O=N>>>
q-K&c,q-=K):(q=K-q,O=(N&c)<<q&c,N=B[k++],q=32-q,O+=N>>>q),A[p]=O<x?E+O*G:a;N=l}O=0}else var C=2===D.encoding?0:D.offset;if(d)for(K=0;K<S;K++){if(Q&7){var y=d[Q>>3];y<<=Q&7}for(B=0;B<P;B++)Q&7||(y=d[Q>>3]),y&128?(v&&(v[Q]=1),p=2>D.encoding?N[O++]:C,b=b>p?p:b,e[Q++]=p):(v&&(v[Q]=0),e[Q++]=F),y<<=1;Q+=R}else if(2>D.encoding)for(K=0;K<S;K++){for(B=0;B<P;B++)p=N[O++],b=b>p?p:b,e[Q++]=p;Q+=R}else for(b=b>C?C:b,K=0;K<S;K++){for(B=0;B<P;B++)e[Q++]=C;Q+=R}if(1===D.encoding&&O!==D.numValidPixels)throw"Block and Mask do not match";
h++}}}C=v;v={width:f.width,height:f.height,pixelData:e,minValue:b,maxValue:f.pixels.maxValue,noDataValue:F};C&&(v.maskData=C);g.returnEncodedMask&&f.mask&&(v.encodedMaskData=f.mask.bitset?f.mask.bitset:null);if(g.returnFileInfo&&(v.fileInfo=z(f),g.computeUsedBitDepths)){g=v.fileInfo;C=f.pixels.numBlocksX*f.pixels.numBlocksY;y={};for(N=0;N<C;N++)O=f.pixels.blocks[N],0===O.encoding?y.float32=!0:1===O.encoding?y[O.bitsPerPixel]=!0:y[0]=!0;f=Object.keys(y);g.bitDepths=f}return v}},z=function(F){return{fileIdentifierString:F.fileIdentifierString,
fileVersion:F.fileVersion,imageType:F.imageType,height:F.height,width:F.width,maxZError:F.maxZError,eofOffset:F.eofOffset,mask:F.mask?{numBlocksX:F.mask.numBlocksX,numBlocksY:F.mask.numBlocksY,numBytes:F.mask.numBytes,maxValue:F.mask.maxValue}:null,pixels:{numBlocksX:F.pixels.numBlocksX,numBlocksY:F.pixels.numBlocksY,numBytes:F.pixels.numBytes,maxValue:F.pixels.maxValue,noDataValue:this.noDataValue}}};return J})},"esri/layers/rasterFormats/Lerc2Codec":function(){define([],function(){var J={unstuff:function(g,
b,d,f,e,h,n,r){var m=(1<<d)-1,w=0,u,l=0;g[g.length-1]<<=8*(4*g.length-Math.ceil(d*f/8));if(e)for(u=0;u<f;u++){if(0===l){var v=g[w++];l=32}if(l>=d){var B=v>>>l-d&m;l-=d}else l=d-l,B=(v&m)<<l&m,v=g[w++],l=32-l,B+=v>>>l;b[u]=e[B]}else for(e=Math.ceil((r-h)/n),u=0;u<f;u++)0===l&&(v=g[w++],l=32),l>=d?(B=v>>>l-d&m,l-=d):(l=d-l,B=(v&m)<<l&m,v=g[w++],l=32-l,B+=v>>>l),b[u]=B<e?h+B*n:r},unstuffLUT:function(g,b,d,f,e,h){var n=(1<<b)-1,r=0,m=0,w=0,u=w=0,l=[];g[g.length-1]<<=8*(4*g.length-Math.ceil(b*d/8));var v=
Math.ceil((h-f)/e);for(m=0;m<d;m++){if(0===w){var B=g[r++];w=32}w>=b?(u=B>>>w-b&n,w-=b):(w=b-w,u=(B&n)<<w&n,B=g[r++],w=32-w,u+=B>>>w);l[m]=u<v?f+u*e:h}l.unshift(f);return l},unstuff2:function(g,b,d,f,e,h,n,r){var m=(1<<d)-1,w=0,u,l=0,v=0;if(e)for(u=0;u<f;u++){if(0===l){var B=g[w++];l=32;v=0}if(l>=d){var K=B>>>v&m;l-=d;v+=d}else{var I=d-l;K=B>>>v&m;B=g[w++];l=32-I;K|=(B&(1<<I)-1)<<d-I;v=I}b[u]=e[K]}else for(e=Math.ceil((r-h)/n),u=0;u<f;u++)0===l&&(B=g[w++],l=32,v=0),l>=d?(K=B>>>v&m,l-=d,v+=d):(I=d-
l,K=B>>>v&m,B=g[w++],l=32-I,K|=(B&(1<<I)-1)<<d-I,v=I),b[u]=K<e?h+K*n:r;return b},unstuffLUT2:function(g,b,d,f,e,h){var n=(1<<b)-1,r=0,m=0,w=0,u=0,l=0,v=0,B=[],K=Math.ceil((h-f)/e);for(m=0;m<d;m++){if(0===u){var I=g[r++];u=32;v=0}u>=b?(l=I>>>v&n,u-=b,v+=b):(w=b-u,l=I>>>v&n,I=g[r++],u=32-w,l|=(I&(1<<w)-1)<<b-w,v=w);B[m]=l<K?f+l*e:h}B.unshift(f);return B},originalUnstuff:function(g,b,d,f){var e=(1<<d)-1,h=0,n,r=0;g[g.length-1]<<=8*(4*g.length-Math.ceil(d*f/8));for(n=0;n<f;n++){if(0===r){var m=g[h++];
r=32}if(r>=d){var w=m>>>r-d&e;r-=d}else r=d-r,w=(m&e)<<r&e,m=g[h++],r=32-r,w+=m>>>r;b[n]=w}return b},originalUnstuff2:function(g,b,d,f){var e=(1<<d)-1,h=0,n,r=0,m=0;for(n=0;n<f;n++){if(0===r){var w=g[h++];r=32;m=0}if(r>=d){var u=w>>>m&e;r-=d;m+=d}else{var l=d-r;u=w>>>m&e;w=g[h++];r=32-l;u|=(w&(1<<l)-1)<<d-l;m=l}b[n]=u}return b}},z={HUFFMAN_LUT_BITS_MAX:12,computeChecksumFletcher32:function(g){for(var b=65535,d=65535,f=g.length,e=Math.floor(f/2),h=0;e;){var n=359<=e?359:e;e-=n;do b+=g[h++]<<8,d+=b+=
g[h++];while(--n);b=(b&65535)+(b>>>16);d=(d&65535)+(d>>>16)}f&1&&(d+=b+=g[h]<<8);return((d&65535)+(d>>>16)<<16|(b&65535)+(b>>>16))>>>0},readHeaderInfo:function(g,b){var d=b.ptr,f=new Uint8Array(g,d,6),e={};e.fileIdentifierString=String.fromCharCode.apply(null,f);if(0!==e.fileIdentifierString.lastIndexOf("Lerc2",0))throw"Unexpected file identifier string (expect Lerc2 ): "+e.fileIdentifierString;d+=6;f=new DataView(g,d,8);var h=f.getInt32(0,!0);e.fileVersion=h;d+=4;3<=h&&(e.checksum=f.getUint32(4,
!0),d+=4);f=new DataView(g,d,12);e.height=f.getUint32(0,!0);e.width=f.getUint32(4,!0);d+=8;4<=h?(e.numDims=f.getUint32(8,!0),d+=4):e.numDims=1;f=new DataView(g,d,40);e.numValidPixel=f.getUint32(0,!0);e.microBlockSize=f.getInt32(4,!0);e.blobSize=f.getInt32(8,!0);e.imageType=f.getInt32(12,!0);e.maxZError=f.getFloat64(16,!0);e.zMin=f.getFloat64(24,!0);e.zMax=f.getFloat64(32,!0);d+=40;b.headerInfo=e;b.ptr=d;if(3<=h&&(g=this.computeChecksumFletcher32(new Uint8Array(g,d-(4<=h?52:48),e.blobSize-14)),g!==
e.checksum))throw"Checksum failed.";return!0},checkMinMaxRanges:function(g,b){var d=b.headerInfo,f=this.getDataTypeArray(d.imageType),e=d.numDims*this.getDataTypeSize(d.imageType),h=this.readSubArray(g,b.ptr,f,e);g=this.readSubArray(g,b.ptr+e,f,e);b.ptr+=2*e;e=!0;for(b=0;b<d.numDims;b++)if(h[b]!==g[b]){e=!1;break}d.minValues=h;d.maxValues=g;return e},readSubArray:function(g,b,d,f){if(d===Uint8Array)g=new Uint8Array(g,b,f);else{var e=new ArrayBuffer(f);(new Uint8Array(e)).set(new Uint8Array(g,b,f));
g=new d(e)}return g},readMask:function(g,b){var d=b.ptr,f=b.headerInfo,e=f.width*f.height,h=f.numValidPixel,n=new DataView(g,d,4);f={};f.numBytes=n.getUint32(0,!0);d+=4;if((0===h||e===h)&&0!==f.numBytes)throw"invalid mask";if(0===h)h=new Uint8Array(Math.ceil(e/8)),f.bitset=h,n=new Uint8Array(e),b.pixels.resultMask=n,d+=f.numBytes;else if(0<f.numBytes){h=new Uint8Array(Math.ceil(e/8));n=new DataView(g,d,f.numBytes);g=n.getInt16(0,!0);var r=2,m=0,w=0;do{if(0<g)for(;g--;)h[m++]=n.getUint8(r++);else for(w=
n.getUint8(r++),g=-g;g--;)h[m++]=w;g=n.getInt16(r,!0);r+=2}while(r<f.numBytes);if(-32768!==g||m<h.length)throw"Unexpected end of mask RLE encoding";n=new Uint8Array(e);for(r=r=g=0;r<e;r++)r&7?(g=h[r>>3],g<<=r&7):g=h[r>>3],g&128&&(n[r]=1);b.pixels.resultMask=n;f.bitset=h;d+=f.numBytes}b.ptr=d;b.mask=f;return!0},readDataOneSweep:function(g,b,d){var f=b.ptr,e=b.headerInfo,h=e.numDims,n=e.width*e.height;e=e.numValidPixel*z.getDataTypeSize(e.imageType)*h;var r=b.pixels.resultMask;if(d===Uint8Array)g=new Uint8Array(g,
f,e);else{var m=new ArrayBuffer(e);(new Uint8Array(m)).set(new Uint8Array(g,f,e));g=new d(m)}if(g.length===n*h)b.pixels.resultPixels=g;else{b.pixels.resultPixels=new d(n*h);var w=m=d=0,u=0;if(1<h)for(w=0;w<h;w++)for(u=w*n,m=0;m<n;m++)r[m]&&(b.pixels.resultPixels[u+m]=g[d++]);else for(m=0;m<n;m++)r[m]&&(b.pixels.resultPixels[m]=g[d++])}b.ptr=f+e;return!0},readHuffmanTree:function(g,b){var d=this.HUFFMAN_LUT_BITS_MAX,f=new DataView(g,b.ptr,16);b.ptr+=16;if(2>f.getInt32(0,!0))throw"unsupported Huffman version";
var e=f.getInt32(4,!0),h=f.getInt32(8,!0);f=f.getInt32(12,!0);if(h>=f)return!1;var n=new Uint32Array(f-h);z.decodeBits(g,b,n);var r=[],m;for(m=h;m<f;m++){var w=m-(m<e?0:e);r[w]={first:n[m-h],second:null}}m=g.byteLength-b.ptr;n=new ArrayBuffer(4*Math.ceil(m/4));(new Uint8Array(n)).set(new Uint8Array(g,b.ptr,m));g=new Uint32Array(n);b=0;n=0;var u=g[0];for(m=h;m<f;m++){w=m-(m<e?0:e);var l=r[w].first;0<l&&(r[w].second=u<<b>>>32-l,32-b>=l?(b+=l,32===b&&(b=0,n++,u=g[n])):(b+=l-32,n++,u=g[n],r[w].second|=
u>>>32-b))}var v=u=0,B=new F;for(m=0;m<r.length;m++)void 0!==r[m]&&(u=Math.max(u,r[m].first));v=u>=d?d:u;d=[];var K;for(m=h;m<f;m++)if(w=m-(m<e?0:e),l=r[w].first,0<l)if(h=[l,w],l<=v){w=r[w].second<<v-l;var I=1<<v-l;for(l=0;l<I;l++)d[w|l]=h}else for(w=r[w].second,I=B,--l;0<=l;l--)(K=w>>>l&1)?(I.right||(I.right=new F),I=I.right):(I.left||(I.left=new F),I=I.left),0!==l||I.val||(I.val=h[1]);return{decodeLut:d,numBitsLUTQick:v,numBitsLUT:u,tree:B,stuffedData:g,srcPtr:n,bitPos:b}},readHuffman:function(g,
b,d){var f=b.headerInfo,e=f.numDims,h=b.headerInfo.height,n=b.headerInfo.width,r=n*h,m=this.readHuffmanTree(g,b);g=m.decodeLut;var w=m.tree,u=m.stuffedData,l=m.srcPtr,v=m.bitPos,B=m.numBitsLUTQick;m=m.numBitsLUT;var K=0===b.headerInfo.imageType?128:0,I=b.pixels.resultMask,S,L,P,Q,R,D,O=0;0<v&&(l++,v=0);var N=u[l],p=1===b.encodeMode,t=new d(r*e),E=t,G;for(G=0;G<f.numDims;G++){1<e&&(E=new d(t.buffer,r*G,r),O=0);if(b.headerInfo.numValidPixel===n*h)for(P=R=0;P<h;P++)for(Q=0;Q<n;Q++,R++){var A=0;var a=
S=N<<v>>>32-B;32-v<B&&(a=S|=u[l+1]>>>64-v-B);if(g[a])A=g[a][1],v+=g[a][0];else for(a=S=N<<v>>>32-m,32-v<m&&(a=S|=u[l+1]>>>64-v-m),a=w,D=0;D<m;D++)if(a=(L=S>>>m-D-1&1)?a.right:a.left,!a.left&&!a.right){A=a.val;v=v+D+1;break}32<=v&&(v-=32,l++,N=u[l]);A-=K;p?(A=0<Q?A+O:0<P?A+E[R-n]:A+O,A&=255,O=E[R]=A):E[R]=A}else for(P=R=0;P<h;P++)for(Q=0;Q<n;Q++,R++)if(I[R]){A=0;a=S=N<<v>>>32-B;32-v<B&&(a=S|=u[l+1]>>>64-v-B);if(g[a])A=g[a][1],v+=g[a][0];else for(a=S=N<<v>>>32-m,32-v<m&&(a=S|=u[l+1]>>>64-v-m),a=w,D=
0;D<m;D++)if(a=(L=S>>>m-D-1&1)?a.right:a.left,!a.left&&!a.right){A=a.val;v=v+D+1;break}32<=v&&(v-=32,l++,N=u[l]);A-=K;p?(A=0<Q&&I[R-1]?A+O:0<P&&I[R-n]?A+E[R-n]:A+O,A&=255,O=E[R]=A):E[R]=A}b.ptr=b.ptr+4*(l+1)+(0<v?4:0)}b.pixels.resultPixels=t},decodeBits:function(g,b,d,f,e){var h=b.headerInfo,n=h.fileVersion,r=0,m=new DataView(g,b.ptr,5<=g.byteLength-b.ptr?5:g.byteLength-b.ptr),w=m.getUint8(0);r++;var u=w>>6,l=0===u?4:3-u,v=0<(w&32)?!0:!1;u=w&31;w=0;if(1===l)w=m.getUint8(r),r++;else if(2===l)w=m.getUint16(r,
!0),r+=2;else if(4===l)w=m.getUint32(r,!0),r+=4;else throw"Invalid valid pixel count type";l=2*h.maxZError;e=1<h.numDims?h.maxValues[e]:h.zMax;if(v){b.counter.lut++;v=m.getUint8(r);r++;h=Math.ceil((v-1)*u/8);var B=Math.ceil(h/4);B=new ArrayBuffer(4*B);var K=new Uint8Array(B);b.ptr+=r;K.set(new Uint8Array(g,b.ptr,h));r=new Uint32Array(B);b.ptr+=h;for(m=0;v-1>>>m;)m++;h=Math.ceil(w*m/8);B=Math.ceil(h/4);B=new ArrayBuffer(4*B);K=new Uint8Array(B);K.set(new Uint8Array(g,b.ptr,h));g=new Uint32Array(B);
b.ptr+=h;b=3<=n?J.unstuffLUT2(r,u,v-1,f,l,e):J.unstuffLUT(r,u,v-1,f,l,e);3<=n?J.unstuff2(g,d,m,w,b):J.unstuff(g,d,m,w,b)}else b.counter.bitstuffer++,m=u,b.ptr+=r,0<m&&(h=Math.ceil(w*m/8),B=Math.ceil(h/4),B=new ArrayBuffer(4*B),K=new Uint8Array(B),K.set(new Uint8Array(g,b.ptr,h)),g=new Uint32Array(B),b.ptr+=h,3<=n?null==f?J.originalUnstuff2(g,d,m,w):J.unstuff2(g,d,m,w,!1,f,l,e):null==f?J.originalUnstuff(g,d,m,w):J.unstuff(g,d,m,w,!1,f,l,e))},readTiles:function(g,b,d){var f=b.headerInfo,e=f.width,h=
f.height,n=f.microBlockSize,r=f.imageType,m=z.getDataTypeSize(r),w=Math.ceil(e/n),u=Math.ceil(h/n);b.pixels.numBlocksY=u;b.pixels.numBlocksX=w;var l=b.pixels.ptr=0,v=0,B=0,K=0,I=0,S=0,L=0,P=0,Q=0,R=0,D=0,O=0,N=0;L=N=L=0;var p=new d(n*n),t=h%n||n,E=e%n||n,G=f.numDims,A,a=b.pixels.resultMask,c=b.pixels.resultPixels,k=5<=f.fileVersion?14:15,q=f.zMax;for(B=0;B<u;B++)for(I=B!==u-1?n:t,K=0;K<w;K++)for(S=K!==w-1?n:E,D=B*e*n+K*n,O=e-S,A=0;A<G;A++){1<G?(N=c,D=B*e*n+K*n,c=new d(b.pixels.resultPixels.buffer,
e*h*A*m,e*h),q=f.maxValues[A]):N=null;L=g.byteLength-b.ptr;l=new DataView(g,b.ptr,Math.min(10,L));v={};L=0;P=l.getUint8(0);L++;var x=5<=f.fileVersion?P&4:0;Q=P>>6&255;R=P>>2&k;if(R!==(K*n>>3&k))throw"integrity issue";if(x&&0===A)throw"integrity issue";P&=3;if(3<P)throw b.ptr+=L,"Invalid block encoding ("+P+")";if(2===P){if(x)if(a)for(l=0;l<I;l++)for(v=0;v<S;v++)a[D]&&(c[D]=N[D]),D++;else for(l=0;l<I;l++)for(v=0;v<S;v++)c[D]=N[D],D++;b.counter.constant++;b.ptr+=L}else if(0===P){if(x)throw"integrity issue";
b.counter.uncompressed++;b.ptr+=L;N=I*S*m;L=g.byteLength-b.ptr;N=N<L?N:L;L=new ArrayBuffer(0===N%m?N:N+m-N%m);x=new Uint8Array(L);x.set(new Uint8Array(g,b.ptr,N));L=new d(L);N=0;if(a)for(l=0;l<I;l++){for(v=0;v<S;v++)a[D]&&(c[D]=L[N++]),D++;D+=O}else for(l=0;l<I;l++){for(v=0;v<S;v++)c[D++]=L[N++];D+=O}b.ptr+=N*m}else if(Q=z.getDataTypeUsed(x&&6>r?4:r,Q),R=z.getOnePixel(v,L,Q,l),L+=z.getDataTypeSize(Q),3===P)if(b.ptr+=L,b.counter.constantoffset++,a)for(l=0;l<I;l++){for(v=0;v<S;v++)a[D]&&(c[D]=x?Math.min(q,
N[D]+R):R),D++;D+=O}else for(l=0;l<I;l++){for(v=0;v<S;v++)c[D]=x?Math.min(q,N[D]+R):R,D++;D+=O}else if(b.ptr+=L,z.decodeBits(g,b,p,R,A),L=0,x)if(a)for(l=0;l<I;l++){for(v=0;v<S;v++)a[D]&&(c[D]=p[L++]+N[D]),D++;D+=O}else for(l=0;l<I;l++){for(v=0;v<S;v++)c[D]=p[L++]+N[D],D++;D+=O}else if(a)for(l=0;l<I;l++){for(v=0;v<S;v++)a[D]&&(c[D]=p[L++]),D++;D+=O}else for(l=0;l<I;l++){for(v=0;v<S;v++)c[D++]=p[L++];D+=O}}},formatFileInfo:function(g){return{fileIdentifierString:g.headerInfo.fileIdentifierString,fileVersion:g.headerInfo.fileVersion,
imageType:g.headerInfo.imageType,height:g.headerInfo.height,width:g.headerInfo.width,numValidPixel:g.headerInfo.numValidPixel,microBlockSize:g.headerInfo.microBlockSize,blobSize:g.headerInfo.blobSize,maxZError:g.headerInfo.maxZError,pixelType:z.getPixelType(g.headerInfo.imageType),eofOffset:g.eofOffset,mask:g.mask?{numBytes:g.mask.numBytes}:null,pixels:{numBlocksX:g.pixels.numBlocksX,numBlocksY:g.pixels.numBlocksY,maxValue:g.headerInfo.zMax,minValue:g.headerInfo.zMin,noDataValue:g.noDataValue}}},
constructConstantSurface:function(g){var b=g.headerInfo.zMax,d=g.headerInfo.numDims,f=g.headerInfo.height*g.headerInfo.width,e=0,h=0,n=0,r=g.pixels.resultMask,m=g.pixels.resultPixels;if(r)if(1<d)for(e=0;e<d;e++)for(n=e*f,b=g.headerInfo.maxValues[e],h=0;h<f;h++)r[h]&&(m[n+h]=b);else for(h=0;h<f;h++)r[h]&&(m[h]=b);else if(1<d)for(e=0;e<d;e++)for(n=e*f,b=g.headerInfo.maxValues[e],h=0;h<f;h++)m[n+h]=b;else for(h=0;h<f;h++)m[h]=b},getDataTypeArray:function(g){switch(g){case 0:g=Int8Array;break;case 1:g=
Uint8Array;break;case 2:g=Int16Array;break;case 3:g=Uint16Array;break;case 4:g=Int32Array;break;case 5:g=Uint32Array;break;case 6:g=Float32Array;break;case 7:g=Float64Array;break;default:g=Float32Array}return g},getPixelType:function(g){switch(g){case 0:g="S8";break;case 1:g="U8";break;case 2:g="S16";break;case 3:g="U16";break;case 4:g="S32";break;case 5:g="U32";break;case 6:g="F32";break;case 7:g="F64";break;default:g="F32"}return g},isValidPixelValue:function(g,b){if(null==b)return!1;switch(g){case 0:g=
-128<=b&&127>=b;break;case 1:g=0<=b&&255>=b;break;case 2:g=-32768<=b&&32767>=b;break;case 3:g=0<=b&&65536>=b;break;case 4:g=-2147483648<=b&&2147483647>=b;break;case 5:g=0<=b&&4294967296>=b;break;case 6:g=-3.4027999387901484E38<=b&&3.4027999387901484E38>=b;break;case 7:g=4.9E-324<=b&&1.7976931348623157E308>=b;break;default:g=!1}return g},getDataTypeSize:function(g){var b=0;switch(g){case 0:case 1:b=1;break;case 2:case 3:b=2;break;case 4:case 5:case 6:b=4;break;case 7:b=8;break;default:b=g}return b},
getDataTypeUsed:function(g,b){var d=g;switch(g){case 2:case 4:d=g-b;break;case 3:case 5:d=g-2*b;break;case 6:d=0===b?g:1===b?2:1;break;case 7:d=0===b?g:g-2*b+1;break;default:d=g}return d},getOnePixel:function(g,b,d,f){g=0;switch(d){case 0:g=f.getInt8(b);break;case 1:g=f.getUint8(b);break;case 2:g=f.getInt16(b,!0);break;case 3:g=f.getUint16(b,!0);break;case 4:g=f.getInt32(b,!0);break;case 5:g=f.getUInt32(b,!0);break;case 6:g=f.getFloat32(b,!0);break;case 7:g=f.getFloat64(b,!0);break;default:throw"the decoder does not understand this pixel type";
}return g}},F=function(g,b,d){this.val=g;this.left=b;this.right=d};return{decode:function(g,b){b=b||{};var d=b.noDataValue,f=0,e={};e.ptr=b.inputOffset||0;e.pixels={};if(z.readHeaderInfo(g,e)){f=e.headerInfo;var h=f.fileVersion,n=z.getDataTypeArray(f.imageType);if(5<h)throw"unsupported lerc version 2."+h;z.readMask(g,e);f.numValidPixel===f.width*f.height||e.pixels.resultMask||(e.pixels.resultMask=b.maskData);var r=f.width*f.height;e.pixels.resultPixels=new n(r*f.numDims);e.counter={onesweep:0,uncompressed:0,
lut:0,bitstuffer:0,constant:0,constantoffset:0};if(0!==f.numValidPixel)if(f.zMax===f.zMin)z.constructConstantSurface(e);else if(4<=h&&z.checkMinMaxRanges(g,e))z.constructConstantSurface(e);else{var m=new DataView(g,e.ptr,2),w=m.getUint8(0);e.ptr++;if(w)z.readDataOneSweep(g,e,n);else if(1<h&&1>=f.imageType&&1E-5>Math.abs(f.maxZError-.5)){m=m.getUint8(1);e.ptr++;e.encodeMode=m;if(2<m||4>h&&1<m)throw"Invalid Huffman flag "+m;m?z.readHuffman(g,e,n):z.readTiles(g,e,n)}else z.readTiles(g,e,n)}e.eofOffset=
e.ptr;b.inputOffset?(g=e.headerInfo.blobSize+b.inputOffset-e.ptr,1<=Math.abs(g)&&(e.eofOffset=b.inputOffset+e.headerInfo.blobSize)):(g=e.headerInfo.blobSize-e.ptr,1<=Math.abs(g)&&(e.eofOffset=e.headerInfo.blobSize));g={width:f.width,height:f.height,pixelData:e.pixels.resultPixels,minValue:f.zMin,maxValue:f.zMax,validPixelCount:f.numValidPixel,dimCount:f.numDims,dimStats:{minValues:f.minValues,maxValues:f.maxValues},maskData:e.pixels.resultMask};if(e.pixels.resultMask&&z.isValidPixelValue(f.imageType,
d)){h=e.pixels.resultMask;for(f=0;f<r;f++)h[f]||(g.pixelData[f]=d);g.noDataValue=d}e.noDataValue=d;b.returnFileInfo&&(g.fileInfo=z.formatFileInfo(e));return g}},getBandCount:function(g){for(var b=0,d=0,f={ptr:0,pixels:{}};d<g.byteLength-58;)z.readHeaderInfo(g,f),d+=f.headerInfo.blobSize,b++,f.ptr=d;return b}}})},"esri/layers/pixelFilters/VectorFieldPixelFilter":function(){define("dojo/_base/declare dojo/_base/lang dojo/has ../../kernel ../../lang dojo/_base/array".split(" "),function(J,z,F,g,b,d){J=
J(null,{declaredClass:"esri.layers.pixelFilters.VectorFieldPixelFilter",speedUnits:["esriMetersPerSecond","esriKilometersPerHour","esriKnots","esriFeetPerSecond","esriMilesPerHour"],constructor:function(f){z.mixin(this,f);this.isDataUV=f&&f.isDataUV?f.isDataUV:!1;this.computeMagnitudeAndDirection=z.hitch(this,this.computeMagnitudeAndDirection);this.unitConversionFactor=1;this._updateUnitConvFactor()},setUnits:function(f,e){this.inputUnit=f;this.outputUnit=e;this.unitConversionFactor=1;this._updateUnitConvFactor()},
_updateUnitConvFactor:function(){var f=d.indexOf(this.speedUnits,this.inputUnit),e=d.indexOf(this.speedUnits,this.outputUnit);if(this.inputUnit&&this.outputUnit&&0<=f&&0<=e){var h=[1,.277778,.514444,.3048,.44704,0];this.unitConversionFactor=h[f]/h[e]}},computeMagnitudeAndDirection:function(f){if(!b.isDefined(f))throw"Could not compute magnitude and direction. No pixel data is available.";var e=f.pixelBlock;if(!b.isDefined(e)||2!==e.getPlaneCount())throw"Could not compute magnitude and direction. Pixel data does not contain two bands.";
var h=f.extent,n=(h.xmax-h.xmin)/e.width,r=(h.ymax-h.ymin)/e.height,m=h.xmin+n/2;h=h.ymax-r/2;e.statistics[0].minValue=0;e.statistics[0].maxValue=0;var w=180/Math.PI,u=[],l=0,v=0,B=0,K=!b.isDefined(e.mask),I,S,L,P;var Q=L=Infinity;var R=P=-Infinity;for(l=0;l<e.height;l++)for(v=0;v<e.width;v++,B++)if(u.push([m+n*v,h-r*l]),K||e.mask[B]){var D=I=e.pixels[0][B]*this.unitConversionFactor;var O=S=e.pixels[1][B];this.isDataUV&&(D=Math.sqrt(I*I+S*S),O=90-w*Math.atan2(S,I),e.pixels[0][B]=D*this.unitConversionFactor,
e.pixels[1][B]=O);D>R&&(R=D);D<Q&&(Q=D);O>P&&(P=O);O<L&&(L=O)}e.statistics[0].maxValue=R;e.statistics[0].minValue=Q;e.statistics[1].maxValue=P;e.statistics[1].minValue=L;f.locations=u;return f}});F("extend-esri")&&z.setObject("layers.pixelFilters.VectorFieldPixelFilter",J,g);return J})},"esri/layers/rasterFormats/ImageCanvasDecoder":function(){define(["require","dojo/_base/declare","dojo/Deferred","dojo/sniff"],function(J,z,F,g){var b;return z(null,{constructor:function(d){this.ctx=d.ctx;this._loadRasterFormatModule()},
decode:function(d,f){if(!f.width||!f.height)throw"Native decoding requires the image format, width and height";var e=new F,h,n=new Uint8Array(d);d=this._getFormat(d);if("error"===d)throw"invalid format";"jpeg"===d&&(h=this._getMask(n,f));var r="",m;for(m=0;m<n.length;m+=65535){var w=n.subarray(m,m+65535>n.length-1?n.length-1:m+65535);r+=String.fromCharCode.apply(null,w)}n="data:image/"+d+";base64,"+window.btoa(r);var u=new Image,l;u.src=n;var v=this;u.onload=function(){v.ctx.clearRect(0,0,f.width,
f.height);v.ctx.drawImage(u,0,0);var B=v.ctx.getImageData(0,0,u.width,u.height);l=B.data;if(h)for(m=0;m<h.length;m++)l[4*m+3]=h[m]?255:0;v.ctx.putImageData(B,0,0);e.resolve(null)};u.onerror=function(){e.reject("cannot load image")};return e},_getFormat:function(d){d=new Uint8Array(d,0,10);var f="error";255===d[0]&&216===d[1]?f="jpeg":137===d[0]&&80===d[1]&&78===d[2]&&71===d[3]&&(f="png");return f},_getMask:function(d,f){try{if(!b)throw"The zlib decoder module is not loaded.";var e=0,h=0,n=Math.round(d.length/
2);1===n%2&&(n+=1);var r=d.length-2;for(e=n;e<r&&(255!==d[e]||217!==d[e+1]);e++);n=e+=2;if(n<d.length-1){var m=(new b(d.subarray(n))).getBytes();var w=new Uint8Array(f.width*f.height);for(e=d=0;e<m.length;e++)for(h=7;0<=h;h--)w[d++]=m[e]>>h&1}}catch(u){}return w},_loadRasterFormatModule:function(){10>g("ie")||J(["./Zlib"],function(d){b=d})}})})},"esri/tasks/ImageServiceIdentifyTask":function(){define("dojo/_base/declare dojo/_base/lang dojo/has ../kernel ../request ../geometry/normalizeUtils ./Task ./ImageServiceIdentifyResult".split(" "),
function(J,z,F,g,b,d,f,e){J=J(f,{declaredClass:"esri.tasks.ImageServiceIdentifyTask",constructor:function(h){this._url.path+="/identify";this._handler=z.hitch(this,this._handler)},__msigns:[{n:"execute",c:3,a:[{i:0,p:["geometry"]}],e:2}],_handler:function(h,n,r,m,w){try{var u=new e(h);this._successHandler([u],"onComplete",r,w)}catch(l){this._errorHandler(l,m,w)}},execute:function(h,n,r,m){var w=m.assembly;h=this._encode(z.mixin({},this._url.query,{f:"json"},h.toJson(w&&w[0])));var u=this._handler,
l=this._errorHandler;return b({url:this._url.path,content:h,callbackParamName:"callback",load:function(v,B){u(v,B,n,r,m.dfd)},error:function(v){l(v,r,m.dfd)}})},onComplete:function(){}});d._createWrappers(J);F("extend-esri")&&z.setObject("tasks.ImageServiceIdentifyTask",J,g);return J})},"esri/tasks/ImageServiceIdentifyResult":function(){define("dojo/_base/declare dojo/_base/lang dojo/has ../kernel ../geometry/jsonUtils ./FeatureSet".split(" "),function(J,z,F,g,b,d){J=J(null,{declaredClass:"esri.tasks.ImageServiceIdentifyResult",
constructor:function(f){f.catalogItems&&(this.catalogItems=new d(f.catalogItems));f.location&&(this.location=b.fromJson(f.location));this.catalogItemVisibilities=f.catalogItemVisibilities;this.name=f.name;this.objectId=f.objectId;this.value=f.value;this.processedValues=f.processedValues;this.properties=f.properties}});F("extend-esri")&&z.setObject("tasks.ImageServiceIdentifyResult",J,g);return J})},"esri/tasks/ImageServiceIdentifyParameters":function(){define("dojo/_base/declare dojo/_base/lang dojo/_base/json dojo/_base/array dojo/has ../kernel ../lang ../geometry/jsonUtils".split(" "),
function(J,z,F,g,b,d,f,e){J=J(null,{declaredClass:"esri.tasks.ImageServiceIdentifyParameters",geometry:null,mosaicRule:null,renderingRule:null,renderingRules:null,pixelSizeX:null,pixelSizeY:null,pixelSize:null,returnGeometry:!1,returnCatalogItems:!0,timeExtent:null,maxItemCount:null,returnPixelValues:!0,toJson:function(h){var n=h&&h.geometry||this.geometry;h={geometry:n,returnGeometry:this.returnGeometry,returnCatalogItems:this.returnCatalogItems,mosaicRule:this.mosaicRule?F.toJson(this.mosaicRule.toJson()):
null,renderingRule:this.renderingRule?F.toJson(this.renderingRule.toJson()):null};n&&(h.geometryType=e.getJsonType(n));n=this.timeExtent;h.time=n?n.toJson().join(","):null;f.isDefined(this.pixelSizeX)&&f.isDefined(this.pixelSizeY)?h.pixelSize=F.toJson({x:parseFloat(this.pixelSizeX),y:parseFloat(this.pixelSizeY)}):this.pixelSize&&(h.pixelSize=this.pixelSize?F.toJson(this.pixelSize.toJson()):null);this.renderingRules&&(h.renderingRules=F.toJson(g.map(this.renderingRules,function(r){return r.toJson()})));
f.isDefined(this.returnPixelValues)&&(h.returnPixelValues=this.returnPixelValues);f.isDefined(this.maxItemCount)&&(h.maxItemCount=this.maxItemCount);return h}});b("extend-esri")&&z.setObject("tasks.ImageServiceIdentifyParameters",J,d);return J})},"*noref":1}});
define("esri/layers/ArcGISImageServiceLayer","dojo/_base/declare dojo/_base/lang dojo/has ../kernel ../config ./DynamicMapServiceLayer ./ImageServiceLayerMixin".split(" "),function(J,z,F,g,b,d,f){J=J([d,f],{declaredClass:"esri.layers.ArcGISImageServiceLayer",constructor:function(e,h){this._initialize(e,h);this.useMapImage=h&&h.useMapImage||!1},refresh:function(e){if(e)this.inherited(arguments);else{var h=this.disableClientCaching;this.disableClientCaching=!0;this.inherited(arguments);this.disableClientCaching=
h}},setRenderer:function(e,h){this.renderer=e;this.onRendererChange();h||this.refresh(!0)},exportMapImage:function(e,h){var n=b.defaults.map;e=z.mixin({size:n.width+","+n.height},this._params,e?e.toJson(this.normalization):{},{f:"json"});delete e._ts;this._exportMapImage(this._url.path+"/exportImage",e,h)}});F("extend-esri")&&z.setObject("layers.ArcGISImageServiceLayer",J,g);return J});